<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ducky & Pips Kingdom</title>
    
    <!-- PWA Settings -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdf2f8">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slight': 'bounce 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        }
                    },
                    colors: {
                        themeYellow: '#fef08a',
                        themeYellowDark: '#854d0e',
                        themeBlue: '#bfdbfe',
                        themeBlueDark: '#1e40af',
                        themePink: '#fbcfe8',
                        themePinkDark: '#9d174d',
                        themeGreen: '#bbf7d0',
                        themeGreenDark: '#166534',
                        themePurple: '#e9d5ff',
                        themePurpleDark: '#6b21a8',
                        themeOrange: '#fed7aa',
                        themeOrangeDark: '#9a3412',
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 rgba(0,0,0,0.05)',
                        'glow': '0 0 20px rgba(255, 255, 255, 0.8)',
                    }
                }
            }
        }
    </script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.378.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/"
  }
}
</script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .perspective-1000 { perspective: 1000px; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { 
            -webkit-user-select: none; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #fdf2f8; 
            background-image: radial-gradient(#fbcfe8 2px, transparent 2px); 
            background-size: 24px 24px;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            overscroll-behavior: none;
        }
        input, textarea, select { -webkit-user-select: auto; user-select: auto; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Heart, Trash2, Plus, Calendar, Repeat, CheckCircle, User, Sparkles, 
            Utensils, Camera, Gift, ArrowLeft, ArrowRight, RefreshCw, LogOut, 
            Star, AlertTriangle, MessageCircle, X, WifiOff, Coins, PiggyBank,
            TrendingUp, DollarSign, HandCoins, Target, CheckSquare, PlusCircle,
            CalendarDays, Clock, Users, ChevronLeft, ChevronRight, AlertCircle,
            Crown, Flag, Settings, BookOpen, Sun, Moon, Coffee, ShoppingCart, ShoppingBag,
            Edit3, MessageSquareHeart, Database, Link as LinkIcon, History, CreditCard, Receipt,
            ChevronDown, ChevronUp, Activity, Cookie, AlertOctagon, ThumbsUp, ThumbsDown, Bell,
            Megaphone, CircleHelp, Pencil, Smile, StickyNote, Shield, Scroll, Store, Send, Lock, ExternalLink, Mail, Palette, RefreshCcw, Copy, Loader
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, 
            deleteDoc, query, orderBy, serverTimestamp, getDoc, setDoc, limit,
            initializeFirestore
        } from 'firebase/firestore';

        // --- CONSTANTS ---
        const FIREBASE_CONFIG = { 
            apiKey: "AIzaSyDou6KkbunVRZrgwf8dM2-Fzooa9hmzHqg",
            authDomain: "ourkingdom-40ac4.firebaseapp.com",
            projectId: "ourkingdom-40ac4",
            storageBucket: "ourkingdom-40ac4.firebasestorage.app",
            messagingSenderId: "692420321112",
            appId: "1:692420321112:web:c9f7d1fff120972ad38f2d",
            measurementId: "G-C3X3ER73CZ"
        };
        
        // Updated Price ID for Live Mode
        const STRIPE_PRICE_ID = "price_1SdLa3CzBDWfuIm1bCaXZkgJ"; 
        
        const APP_ID = 'ducky-pips-v1';
        const DEFAULT_CHORES_PER_COUPON = 5; 
        const DEFAULT_CHORES_PER_DATENIGHT = 20;
        const DEFAULT_COUPONS = ["15 min Back Massage", "Homemade Dinner Choice", "Dish Duty Pass", "Movie Selection", "Breakfast in Bed", "Foot Massage", "Veto Power", "Ice Cream Run", "Bubble Bath Setup", "30 min Gaming Time"];
        const FREQUENCIES = ['Once', 'Daily', 'Weekly', 'Monthly', 'Yearly'];
        const BILL_FREQUENCIES = ['One-time', 'Weekly', 'Monthly', 'Yearly'];
        const GOAL_TIMEFRAMES = ["This Week", "This Month", "1 Year", "5 Years", "10 Years", "20 Years"];
        const DATE_FOODS = ["Sushi", "Pizza", "Tacos", "Thai", "Burgers", "Fondue", "Pasta", "Picnic"];
        const DOMINANCE_WEIGHTS = { MONEY_TO_POINT_RATIO: 25, CHORE_POINT: 1, EQUALITY_THRESHOLD: 4 };
        const JOKE_RATINGS = { funny: { label: 'Funny', emoji: 'üòÜ', weight: 1 }, hilarious: { label: 'Hilarious', emoji: 'ü§£', weight: 3 } };
        const ROYAL_TITLES = {
            finance: { he: "Lord Treasurer", she: "Lady Treasurer", they: "High Treasurer" },
            chores: { he: "Grand Steward", she: "High Stewardess", they: "High Steward" },
            planning: { he: "Grand Vizier", she: "Grand Vizier", they: "Grand Vizier" },
            shopping: { he: "Royal Merchant", she: "Royal Merchant", they: "Royal Merchant" },
            jester: { he: "Court Jester", she: "Court Jester", they: "Court Jester" },
            scribe: { he: "Royal Scribe", she: "Royal Scribe", they: "Royal Scribe" },
            ruler: { he: "King", she: "Queen", they: "Monarch" }
        };
        const THEME_COLORS = [
            { name: 'Yellow', bg: 'bg-themeYellow', text: 'text-themeYellowDark', border: 'border-themeYellow' },
            { name: 'Blue', bg: 'bg-themeBlue', text: 'text-themeBlueDark', border: 'border-themeBlue' },
            { name: 'Pink', bg: 'bg-themePink', text: 'text-themePinkDark', border: 'border-themePink' },
            { name: 'Green', bg: 'bg-themeGreen', text: 'text-themeGreenDark', border: 'border-themeGreen' },
            { name: 'Purple', bg: 'bg-themePurple', text: 'text-themePurpleDark', border: 'border-themePurple' },
            { name: 'Orange', bg: 'bg-themeOrange', text: 'text-themeOrangeDark', border: 'border-themeOrange' },
        ];
        const ICONS = ['üê•','üê¶','üê∏','üê∑','ü¶Ñ','üêº','ü¶ä','ü¶Å','üêß','üêù', 'üê±', 'üê∂', 'üê®', 'üêØ', 'üêô'];
        
        // --- FIREBASE INIT ---
        const app = initializeApp(FIREBASE_CONFIG);
        const auth = getAuth(app);
        
        // Init Firestore with Long Polling to prevent QUIC errors (net::ERR_QUIC_PROTOCOL_ERROR)
        const db = initializeFirestore(app, {
            experimentalForceLongPolling: true
        });

        // --- STATS LOGIC (Global) ---
        const calculateKingdomStats = (timeframe, completed, bills, goals, activities, events, jokes, notes, ious) => {
            const now = new Date();
            const start = new Date(now);
            if (timeframe === 'weekly') {
                const day = start.getDay(), diff = start.getDate() - day + (day === 0 ? -6 : 1);
                start.setDate(diff);
            } else if (timeframe === 'monthly') {
                start.setDate(1);
            } else {
                start.setMonth(0, 1);
            }
            start.setHours(0,0,0,0);

            const s = { Ducky: { chores: 0, money: 0, planning: 0, shopping: 0, jokes: 0, notes: 0 }, Pips: { chores: 0, money: 0, planning: 0, shopping: 0, jokes: 0, notes: 0 } };
            const isAfterStart = (ts) => ts && new Date(ts.seconds * 1000) >= start;
            const isDeed = (c) => { if (c.type === 'whim') return false; if (c.goalId) { const g = goals.find(goal => goal.id === c.goalId); if (g && g.type === 'personal') return false; } return true; };

            completed.forEach(c => { 
                if (c.completedBy && s[c.completedBy] && isAfterStart(c.completedAt) && isDeed(c)) s[c.completedBy].chores++; 
            });
            bills.forEach(b => { (b.payments || []).forEach(p => { if (new Date(p.date) >= start && s[p.who]) s[p.who].money += p.amount; }); });
            goals.forEach(g => { (g.contributions || []).forEach(c => { if (new Date(c.date) >= start && s[c.who]) s[c.who].money += c.amount; }); });
            activities.forEach(a => { 
                const match = a.description.match(/\(\$(\d+(\.\d+)?)\)/); 
                if (match && a.who && s[a.who] && isAfterStart(a.createdAt)) { s[a.who].money += parseFloat(match[1]); }
                if(isAfterStart(a.createdAt) && a.description.includes('Shopping') && s[a.who]) s[a.who].shopping++;
            });
            ious.forEach(i => { if (i.status === 'approved' && i.to && s[i.to]) { s[i.to].money += i.amount; } });
            events.forEach(e => { if (new Date(e.date) >= start && s[e.owner]) s[e.owner].planning++; });
            jokes.forEach(j => { const weight = JOKE_RATINGS[j.rating]?.weight || 1; if (isAfterStart(j.createdAt)) { if (j.who === 'Both') { s.Ducky.jokes += weight; s.Pips.jokes += weight; } else if (s[j.who]) { s[j.who].jokes += weight; } } });
            notes.forEach(n => { if (isAfterStart(n.createdAt) && s[n.createdBy]) { s[n.createdBy].notes++; } });
            return s;
        };

        // --- SHARED COMPONENTS ---

        const ModalWrapper = ({ children, onClose, title, icon }) => (
            <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl animate-in zoom-in-95 duration-200 border-4 border-gray-100 relative max-h-[85vh] overflow-y-auto no-scrollbar">
                    <button onClick={onClose} className="absolute top-6 right-6 text-gray-300 hover:text-gray-500 bg-gray-50 p-2 rounded-full"><X size={20}/></button>
                    <h2 className="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3">{icon} {title}</h2>
                    {children}
                </div>
            </div>
        );

        const NavButton = ({ active, onClick, icon, label, count, prominent }) => {
            if (prominent) return (
                <button onClick={onClick} className="relative -top-10 z-50 flex flex-col items-center justify-center group shrink-0 mx-1">
                    <div className={`w-20 h-20 rounded-full shadow-glow flex items-center justify-center border-[6px] border-gray-50 transition-transform duration-300 group-hover:scale-105 ${active ? 'bg-gradient-to-br from-pink-400 to-purple-500 text-white' : 'bg-white text-gray-300'}`}>{React.cloneElement(icon, { size: 32, strokeWidth: 3 })}</div>
                </button>
            )
            return (
                <button onClick={onClick} className={`flex flex-col items-center justify-center py-1 transition-all relative w-full h-14 rounded-2xl ${active ? 'bg-white shadow-cute text-pink-500 -translate-y-1' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'}`}>
                    {React.cloneElement(icon, { size: 20, strokeWidth: 2.5 })}
                    <span className="text-[9px] font-bold leading-tight mt-0.5">{label}</span>
                    {count > 0 && <span className="absolute top-1 right-2 bg-red-500 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold animate-bounce shadow-sm border border-white">{count}</span>}
                </button>
            );
        };

        const ProgressBar = ({ current, max, color = "bg-pink-500", label }) => (
            <div className="w-full mb-4">
                {label && <div className="flex justify-between text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider ml-1"><span>{label}</span><span>{current} / {max}</span></div>}
                <div className="h-5 w-full bg-white rounded-full overflow-hidden border-2 border-gray-100 shadow-inner">
                    <div className={`h-full ${color} transition-all duration-1000 ease-out flex items-center justify-end pr-2 rounded-full`} style={{ width: `${Math.min((current/max)*100, 100)}%` }}>{current>=max && <Sparkles size={12} className="text-white animate-spin-slow" />}</div>
                </div>
            </div>
        );

        const Paywall = ({ title, description, icon, onSubscribe }) => (
            <div className="h-full flex flex-col items-center justify-center p-6 text-center animate-in fade-in">
                <div className="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-6 relative shadow-cute border-4 border-white">
                    <div className="opacity-50 grayscale scale-110">{icon}</div>
                    <div className="absolute -bottom-1 -right-1 bg-black text-white p-2.5 rounded-full border-4 border-white shadow-sm">
                        <Lock size={18} />
                    </div>
                </div>
                <h2 className="text-2xl font-black text-gray-800 mb-2">{title}</h2>
                <p className="text-gray-500 text-sm mb-8 leading-relaxed max-w-[250px] mx-auto font-medium">{description}</p>
                <button onClick={onSubscribe} className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-4 rounded-2xl font-black shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                    <Star fill="currentColor" strokeWidth={2} /> Upgrade to Unlock
                </button>
            </div>
        );

        class ErrorBoundary extends React.Component {
            state = { hasError: false, error: null };
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() { 
                if (this.state.hasError) return (
                    <div className="p-6 text-center h-screen flex flex-col items-center justify-center">
                        <h2 className="text-xl font-bold text-red-500 mb-2">Oh no! A glitch! üêõ</h2>
                        <button onClick={() => window.location.reload()} className="bg-black text-white px-6 py-3 rounded-full font-bold shadow-cute">Reload Kingdom</button>
                    </div>
                ); 
                return this.props.children; 
            }
        }

        const ChoreItem = ({ chore, onToggle, onDelete, isPretty, showAssignee }) => {
            const [isExpanded, setIsExpanded] = useState(false);
            const isOverdue = chore.dueDate && new Date(chore.dueDate) < new Date() && !isPretty;
            return (
                <div className={`group relative bg-white rounded-3xl p-4 shadow-cute border-2 transition-all hover:shadow-md flex items-start gap-4 animate-pop ${isPretty ? 'border-pink-200 bg-gradient-to-r from-white to-pink-50' : 'border-gray-100'} ${isOverdue ? 'border-red-200 bg-red-50' : ''}`}>
                    <button onClick={(e) => { e.stopPropagation(); onToggle(chore); }} className={`mt-1 w-10 h-10 rounded-full border-4 flex items-center justify-center transition-colors shadow-sm shrink-0 ${isPretty ? 'border-pink-200 text-pink-500 hover:bg-pink-100' : 'border-gray-200 text-transparent hover:border-green-400 hover:text-green-400 bg-gray-50'}`}><CheckCircle size={22} strokeWidth={3} className={isPretty?"opacity-100":"opacity-0 hover:opacity-100"}/></button>
                    <div className="flex-1 overflow-hidden cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                        <h3 className={`font-black text-gray-700 text-lg leading-tight ${isExpanded ? 'whitespace-pre-wrap' : 'truncate'} ${isPretty ? 'text-pink-600' : ''}`}>{chore.title}</h3>
                        <div className="flex flex-wrap gap-2 text-[10px] font-bold text-gray-400 mt-1.5">
                            {showAssignee && <span className={`flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-100 text-gray-600`}>{chore.assignedTo}</span>}
                            {!isPretty && chore.frequency && <span className="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-lg"><RefreshCw size={10} /> {chore.frequency}</span>}
                            {!isPretty && chore.dueDate && <span className={`flex items-center gap-1 px-2 py-1 rounded-lg ${isOverdue ? 'bg-red-100 text-red-600' : 'bg-gray-100'}`}><Calendar size={10} /> {new Date(chore.dueDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span>}
                            {isPretty && <span className="flex items-center gap-1 bg-pink-100 text-pink-600 px-2 py-1 rounded-lg border border-pink-200">Favor ‚ú®</span>}
                            {chore.type === 'whim' && <span className="flex items-center gap-1 bg-purple-100 text-purple-600 px-2 py-1 rounded-lg border border-purple-200">Whim ü¶Ñ</span>}
                            {chore.goalId && <span className="flex items-center gap-1 bg-blue-100 text-blue-600 px-2 py-1 rounded-lg border border-blue-200">Goal üéØ</span>}
                        </div>
                        {isExpanded && <p className="text-xs text-gray-400 mt-2 italic">Tap to collapse</p>}
                    </div>
                    {onDelete && <button onClick={(e) => { e.stopPropagation(); onDelete(chore.id); }} className="opacity-0 group-hover:opacity-100 p-2 text-gray-300 hover:text-red-400 transition-opacity bg-white rounded-full shadow-sm border border-gray-100 shrink-0"><Trash2 size={18}/></button>}
                </div>
            );
        };

        const BillCardItem = ({ bill, isPaid, dr, onPayBill, onEditBill }) => {
            const paid = bill.totalPaid || 0;
            const duckyPaid = (bill.payments || []).filter(p => p.who === 'Ducky').reduce((s,p) => s + p.amount, 0);
            const pipsPaid = (bill.payments || []).filter(p => p.who === 'Pips').reduce((s,p) => s + p.amount, 0);
            const duckyShare = bill.amount * dr;
            const pipsShare = bill.amount * (1 - dr);

            return (
                <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-2 group">
                    <div className="flex justify-between items-start mb-2">
                        <div>
                            <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                {bill.title}
                                <button onClick={() => onEditBill(bill)} className="text-gray-300 hover:text-blue-500 transition-colors bg-gray-50 p-1 rounded-full"><Pencil size={12}/></button>
                            </h3>
                            <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wide">{bill.frequency} ‚Ä¢ Due {new Date(bill.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}</div>
                        </div>
                        <div className="text-right">
                            <div className="font-black text-gray-800">${paid} / ${bill.amount}</div>
                            {!isPaid && <button onClick={() => onPayBill(bill)} className="text-[10px] font-bold bg-green-100 text-green-600 px-2 py-1 rounded-md mt-1">Pay Portion</button>}
                        </div>
                    </div>
                    <div className="h-3 w-full bg-gray-100 rounded-full overflow-hidden relative">
                        <div className="absolute top-0 bottom-0 w-0.5 bg-black/20 z-10" style={{ left: `${dr * 100}%` }}></div>
                        <div className="h-full flex">
                            <div style={{ width: `${(duckyPaid / bill.amount) * 100}%` }} className="bg-yellow-400 h-full"></div>
                            <div style={{ width: `${(pipsPaid / bill.amount) * 100}%` }} className="bg-blue-400 h-full"></div>
                        </div>
                    </div>
                    <div className="flex justify-between mt-2 text-[10px] font-bold border-t border-gray-50 pt-2">
                        <span className="text-yellow-700 flex items-center gap-1">üê• Ducky: ${duckyShare.toFixed(2)}</span>
                        <span className="text-blue-700 flex items-center gap-1">üê¶ Pips: ${pipsShare.toFixed(2)}</span>
                    </div>
                </div>
            );
        };

        const CastleSettingsModal = ({ onClose, settings, onUpdateSettings, onOpenProfile }) => {
            const [name, setName] = useState(settings?.name || 'Our Kingdom');
            const [kFlag, setKFlag] = useState(settings?.kingdomFlag || 'üè∞');
            const [dFlag, setDFlag] = useState(settings?.duckyFlag || 'üê•');
            const [pFlag, setPFlag] = useState(settings?.pipsFlag || 'üê¶');
            return (
                <ModalWrapper onClose={onClose} title="Kingdom Settings" icon={<Settings className="text-gray-400" size={28}/>}>
                    <div className="space-y-4"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Castle Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 font-bold" value={name} onChange={e => setName(e.target.value)} /></div><div className="pt-4 border-t border-gray-100"><label className="block text-xs font-bold text-gray-400 mb-2 uppercase ml-1">My Settings</label><button onClick={onOpenProfile} className="w-full bg-gray-100 text-gray-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-200"><User size={18} /> Edit My Profile (Name & Pronouns)</button></div><div className="grid grid-cols-3 gap-2"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Kingdom</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-center text-2xl" value={kFlag} onChange={e => setKFlag(e.target.value)} /></div><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Ducky</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-center text-2xl" value={dFlag} onChange={e => setDFlag(e.target.value)} /></div><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Pips</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-center text-2xl" value={pFlag} onChange={e => setPFlag(e.target.value)} /></div></div><button onClick={() => { onUpdateSettings({ name, kingdomFlag: kFlag, duckyFlag: dFlag, pipsFlag: pFlag }); onClose(); }} className="w-full bg-black text-white py-3 rounded-xl font-bold mt-4 shadow-cute">Save Changes</button></div>
                </ModalWrapper>
            );
        };

        const ProfileSettingsModal = ({ onClose, profile, settings, onSave }) => {
            const [name, setName] = useState(settings?.name); const [icon, setIcon] = useState(settings?.icon); const [theme, setTheme] = useState(settings?.theme || 'Yellow'); const [pronouns, setPronouns] = useState(settings?.pronouns || 'they');
            return (
                <ModalWrapper onClose={onClose} title="My Profile" icon={<User className="text-blue-400" size={28}/>}>
                    <div className="space-y-6"><div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-bold text-gray-700" value={name} onChange={e=>setName(e.target.value)}/></div><div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Pronouns</label><div className="flex bg-gray-100 rounded-xl p-1">{['he', 'she', 'they'].map(p => (<button key={p} onClick={() => setPronouns(p)} className={`flex-1 py-2 rounded-lg text-xs font-bold capitalize ${pronouns === p ? 'bg-white shadow text-black' : 'text-gray-400'}`}>{p}/{p === 'he' ? 'him' : (p === 'she' ? 'her' : 'them')}</button>))}</div></div><div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Icon</label><div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{ICONS.map(ic=><button key={ic} onClick={()=>setIcon(ic)} className={`text-2xl p-3 rounded-2xl border-2 transition-all ${icon===ic?'border-black bg-gray-100':'border-transparent hover:bg-gray-50'}`}>{ic}</button>)}</div></div><div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Theme</label><div className="grid grid-cols-3 gap-2">{THEME_COLORS.map(t=><button key={t.name} onClick={()=>setTheme(t.name)} className={`py-3 rounded-2xl text-xs font-bold border-2 transition-all ${theme===t.name? 'border-black opacity-100 scale-105':'border-transparent opacity-60'} ${t.bg} ${t.text}`}>{t.name}</button>)}</div></div><button onClick={()=>{onSave({name,icon,theme,pronouns}); onClose();}} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-cute mt-2">Save Profile</button></div>
                </ModalWrapper>
            );
        };

        const AuthComponent = () => {
            const [isLogin, setIsLogin] = useState(true); const [email, setEmail] = useState(''); const [password, setPassword] = useState(''); const [error, setError] = useState(''); const [loading, setLoading] = useState(false);
            const handleSubmit = async (e) => { e.preventDefault(); setError(''); setLoading(true); try { if (isLogin) { await signInWithEmailAndPassword(auth, email, password); } else { await createUserWithEmailAndPassword(auth, email, password); } } catch (err) { setError(err.message.replace('Firebase: ', '')); } finally { setLoading(false); } };
            return (
                <div className="fixed inset-0 z-[100] bg-pink-50 overflow-y-auto overscroll-y-auto">
                    <div className="min-h-full flex flex-col items-center justify-center p-6 relative font-sans">
                        <div className="absolute top-10 left-10 w-32 h-32 bg-yellow-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-float pointer-events-none"></div><div className="absolute bottom-10 right-10 w-32 h-32 bg-blue-200 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-float pointer-events-none" style={{ animationDelay: '2s' }}></div>
                        <div className="w-full max-w-md bg-white/80 backdrop-blur-md p-8 rounded-[2.5rem] shadow-2xl border-4 border-white relative z-10 animate-pop my-auto">
                            <div className="text-center mb-8"><div className="w-20 h-20 bg-gradient-to-br from-pink-400 to-purple-500 rounded-3xl mx-auto flex items-center justify-center shadow-lg transform rotate-3 mb-4"><Heart className="text-white" size={40} fill="currentColor" /></div><h1 className="text-3xl font-black text-gray-800 tracking-tight">{isLogin ? 'Welcome Back!' : 'Join the Kingdom'}</h1><p className="text-gray-500 text-sm mt-2 font-medium">{isLogin ? 'Enter your castle credentials' : 'Create your shared space'}</p></div>{error && <div className="bg-red-50 border-2 border-red-100 text-red-500 p-3 rounded-xl mb-4 text-xs font-bold text-center">{error}</div>}
                            <form onSubmit={handleSubmit} className="space-y-4"><div className="space-y-2"><label className="text-xs font-black text-gray-400 uppercase ml-2">Email</label><div className="relative"><Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-3 pl-12 pr-4 font-bold text-gray-700 focus:outline-none focus:border-pink-300 transition-colors" placeholder="you@love.com" required /></div></div><div className="space-y-2"><label className="text-xs font-black text-gray-400 uppercase ml-2">Password</label><div className="relative"><Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={18} /><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-3 pl-12 pr-4 font-bold text-gray-700 focus:outline-none focus:border-pink-300 transition-colors" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required /></div></div><button type="submit" disabled={loading} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 mt-4">{loading ? 'Processing...' : (isLogin ? 'Enter Kingdom' : 'Create Account')} {!loading && <ArrowRight size={18} />}</button></form><div className="mt-6 text-center"><button onClick={() => setIsLogin(!isLogin)} className="text-sm font-bold text-gray-400 hover:text-pink-500 transition-colors">{isLogin ? "New here? Create an account" : "Already have a castle? Sign in"}</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const Onboarding = ({ onComplete }) => {
            const [step, setStep] = useState(1); const [p1Name, setP1Name] = useState(''); const [p1Icon, setP1Icon] = useState('üê•'); const [p1Theme, setP1Theme] = useState('Yellow'); const [p1Pronouns, setP1Pronouns] = useState('they'); const [p2Name, setP2Name] = useState(''); const [p2Icon, setP2Icon] = useState('üê¶'); const [p2Theme, setP2Theme] = useState('Blue'); const [p2Pronouns, setP2Pronouns] = useState('they'); const [kingdomName, setKingdomName] = useState('Our Kingdom'); const [kingdomFlag, setKingdomFlag] = useState('üè∞'); const [chores, setChores] = useState(['Wash Dishes', 'Take out Trash', 'Water Plants', 'Vacuum', 'Make Bed']); const [newChore, setNewChore] = useState('');
            const handleNext = () => { if (step === 1 && !p1Name) return; if (step === 2 && !p2Name) return; if (step === 3 && !kingdomName) return; setStep(step + 1); };
            const handleSubmit = () => { onComplete({ p1: { name: p1Name, icon: p1Icon, theme: p1Theme, pronouns: p1Pronouns }, p2: { name: p2Name, icon: p2Icon, theme: p2Theme, pronouns: p2Pronouns }, kingdomName, kingdomFlag, initialChores: chores }); };
            const ThemeSelector = ({ selected, onSelect }) => (<div className="grid grid-cols-3 gap-2 mt-2">{THEME_COLORS.map(t => (<button key={t.name} type="button" onClick={() => onSelect(t.name)} className={`py-2 rounded-xl text-xs font-bold border-2 transition-all ${selected === t.name ? 'border-black opacity-100 scale-105' : 'border-transparent opacity-60'} ${t.bg} ${t.text}`}>{t.name}</button>))}</div>);
            // Updated IconSelector to be a grid
            const IconSelector = ({ selected, onSelect }) => (<div className="grid grid-cols-5 gap-2 mt-2">{ICONS.map(ic => (<button key={ic} type="button" onClick={() => onSelect(ic)} className={`text-2xl w-full aspect-square rounded-2xl border-2 transition-all flex items-center justify-center ${selected === ic ? 'border-black bg-gray-100 scale-110' : 'border-gray-100 hover:bg-gray-50'}`}>{ic}</button>))}</div>);
            const PronounSelector = ({ selected, onSelect }) => (<div className="flex bg-gray-100 rounded-xl p-1 mt-2">{['he', 'she', 'they'].map(p => (<button key={p} type="button" onClick={() => onSelect(p)} className={`flex-1 py-2 rounded-lg text-xs font-bold capitalize ${selected === p ? 'bg-white shadow text-black' : 'text-gray-400'}`}>{p === 'he' ? 'He' : (p === 'she' ? 'She' : 'They')}</button>))}</div>);
            return (
                <div className="fixed inset-0 z-[100] bg-pink-50 overflow-y-auto overscroll-y-auto">
                    <div className="min-h-full flex flex-col items-center justify-center p-6 font-sans">
                        <div className="w-full max-w-md bg-white rounded-[2.5rem] p-8 shadow-2xl border-4 border-white animate-in zoom-in duration-300 my-auto">
                            <div className="flex gap-2 mb-8">{[1,2,3,4].map(i => (<div key={i} className={`h-2 flex-1 rounded-full transition-colors ${i <= step ? 'bg-pink-500' : 'bg-gray-100'}`}></div>))}</div>
                            {step === 1 && (<div className="space-y-6 animate-in slide-in-from-right"><div className="text-center"><h2 className="text-2xl font-black text-gray-800">Who is Ruler #1?</h2><p className="text-gray-500 text-sm">Tell us about the first partner.</p></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Name</label><input value={p1Name} onChange={e => setP1Name(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-bold text-lg" placeholder="e.g. Ducky" autoFocus /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Icon</label><IconSelector selected={p1Icon} onSelect={setP1Icon} /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Pronouns</label><PronounSelector selected={p1Pronouns} onSelect={setP1Pronouns} /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Royal Theme</label><ThemeSelector selected={p1Theme} onSelect={setP1Theme} /></div><button onClick={handleNext} disabled={!p1Name} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-lg mt-4 flex items-center justify-center gap-2">Next <ArrowRight size={20}/></button></div>)}
                            {step === 2 && (<div className="space-y-6 animate-in slide-in-from-right"><div className="text-center"><h2 className="text-2xl font-black text-gray-800">Who is Ruler #2?</h2><p className="text-gray-500 text-sm">Tell us about the second partner.</p></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Name</label><input value={p2Name} onChange={e => setP2Name(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-bold text-lg" placeholder="e.g. Pips" autoFocus /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Icon</label><IconSelector selected={p2Icon} onSelect={setP2Icon} /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Pronouns</label><PronounSelector selected={p2Pronouns} onSelect={setP2Pronouns} /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Royal Theme</label><ThemeSelector selected={p2Theme} onSelect={setP2Theme} /></div><button onClick={handleNext} disabled={!p2Name} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-lg mt-4 flex items-center justify-center gap-2">Next <ArrowRight size={20}/></button></div>)}
                            {step === 3 && (<div className="space-y-6 animate-in slide-in-from-right"><div className="text-center"><Crown className="mx-auto text-yellow-400 mb-4" size={48} /><h2 className="text-2xl font-black text-gray-800">Name Your Kingdom</h2></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Kingdom Name</label><input value={kingdomName} onChange={e => setKingdomName(e.target.value)} className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-bold text-lg" placeholder="e.g. Our Happy Place" autoFocus /></div><div><label className="text-xs font-black text-gray-400 uppercase ml-2">Kingdom Flag</label><div className="grid grid-cols-4 gap-3 mt-2 justify-center">{['üè∞','‚õ∫','üè†','üèùÔ∏è','üíí','üé¢'].map(f => (<button key={f} type="button" onClick={() => setKingdomFlag(f)} className={`text-3xl aspect-square rounded-2xl border-2 flex items-center justify-center transition-all ${kingdomFlag === f ? 'border-pink-500 bg-pink-50 scale-110' : 'border-gray-100 hover:bg-gray-50'}`}>{f}</button>))}</div></div><button onClick={handleNext} disabled={!kingdomName} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-lg mt-4 flex items-center justify-center gap-2">Next <ArrowRight size={20}/></button></div>)}
                            {step === 4 && (<div className="space-y-6 animate-in slide-in-from-right"><div className="text-center"><CheckCircle className="mx-auto text-green-400 mb-4" size={48} /><h2 className="text-2xl font-black text-gray-800">First Royal Decrees</h2><p className="text-gray-500 text-sm">Add some chores to the assignment pile.</p></div><div className="bg-gray-50 p-4 rounded-2xl border-2 border-gray-100 max-h-48 overflow-y-auto custom-scrollbar">{chores.map((c, i) => (<div key={i} className="flex justify-between items-center bg-white p-2 rounded-xl border border-gray-200 mb-2 last:mb-0"><span className="text-sm font-bold text-gray-700 ml-2">{c}</span><button onClick={() => setChores(chores.filter((_, idx) => idx !== i))} className="p-2 text-gray-300 hover:text-red-400"><Trash2 size={16}/></button></div>))}</div><div className="flex gap-2"><input value={newChore} onChange={e => setNewChore(e.target.value)} onKeyDown={e => {if(e.key === 'Enter' && newChore) {setChores([...chores, newChore]); setNewChore('');}}} className="flex-1 bg-white border-2 border-gray-200 rounded-xl p-3 font-bold text-sm" placeholder="Add chore..." /><button onClick={() => { if(newChore) { setChores([...chores, newChore]); setNewChore(''); }}} className="bg-black text-white px-4 rounded-xl"><Plus /></button></div><button onClick={handleSubmit} className="w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-4 rounded-2xl font-black shadow-lg mt-4 flex items-center justify-center gap-2 hover:scale-[1.02] transition-transform"><Sparkles size={20}/> Enter Kingdom</button></div>)}
                        </div>
                    </div>
                </div>
            );
        };

        // ... (Other components: BudgetView, GoalsView, etc. remain unchanged) ...
        const BudgetView = ({ bills, income, ious, user, onUpdateIncome, onPayBill, onEditBill, onRequestIOU, onPayIOU, onClearIOU, onApproveIOU, onDeleteIOU }) => {
            const tot = (Number(income.ducky)||0)+(Number(income.pips)||0); const dr = tot>0?(Number(income.ducky)/tot):0.5; const unpaid = bills.filter(b => (b.totalPaid || 0) < b.amount); const paid = bills.filter(b => (b.totalPaid || 0) >= b.amount); const incomingRequests = ious.filter(i => i.to === user && i.status === 'pending'); const pendingCount = incomingRequests.length;
            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><h2 className="text-xs font-bold text-gray-400 uppercase mb-3">Monthly Income</h2><div className="flex gap-4 mb-4"><input type="number" className="w-full bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-sm" value={income.ducky} onChange={(e)=>onUpdateIncome({ducky:e.target.value})} placeholder="Ducky $"/><input type="number" className="w-full bg-blue-50 border border-blue-200 rounded-lg p-2 text-sm" value={income.pips} onChange={(e)=>onUpdateIncome({pips:e.target.value})} placeholder="Pips $"/></div><div className="h-4 bg-gray-100 rounded-full flex overflow-hidden"><div style={{width:`${dr*100}%`}} className="bg-yellow-300 h-full flex items-center justify-center text-[10px] font-bold text-yellow-800">{Math.round(dr*100)}%</div><div className="flex-1 bg-blue-300 h-full flex items-center justify-center text-[10px] font-bold text-blue-800">{Math.round((1-dr)*100)}%</div></div></div>
                    <div className="bg-pink-50 rounded-2xl p-4 border-2 border-pink-200 relative">{pendingCount > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold animate-pulse z-10">{pendingCount}</span>}<div className="flex justify-between items-center mb-3"><h2 className="text-pink-600 font-bold text-sm uppercase flex gap-2"><HandCoins size={16}/> IOU</h2><button onClick={onRequestIOU} className="bg-white text-pink-500 px-3 py-1 rounded-full text-xs font-bold shadow-sm">Borrow Request</button></div>{incomingRequests.length > 0 && (<div className="mb-4 space-y-2"><h4 className="text-xs font-black text-pink-400 uppercase">Requests to Borrow from You</h4>{incomingRequests.map(i => (<div key={i.id} className="bg-white p-3 rounded-xl border border-pink-200 flex justify-between items-center"><div><div className="text-xs font-bold text-gray-700">{i.from} wants to borrow ${i.amount}</div><div className="text-[10px] text-gray-400">{i.reason}</div></div><div className="flex gap-2"><button onClick={()=>onApproveIOU(i.id)} className="bg-green-100 text-green-600 p-1.5 rounded-lg"><ThumbsUp size={14}/></button><button onClick={()=>onDeleteIOU(i.id)} className="bg-red-100 text-red-600 p-1.5 rounded-lg"><X size={14}/></button></div></div>))}</div>)}{ious.filter(i => i.status === 'approved').map(i=><div key={i.id} className="bg-white p-3 rounded-xl border border-pink-100 flex justify-between items-center mb-2"><div><div className="text-xs font-bold text-gray-700">{i.from} owes {i.to} ${i.amount}</div><div className="text-[10px] text-gray-400">{i.reason}</div></div><div className="flex items-center gap-2"><button onClick={() => onPayIOU(i)} className="text-xs font-bold bg-green-100 text-green-600 px-2 py-1 rounded-lg hover:bg-green-200">Pay</button><button onClick={()=>onClearIOU(i.id)} className="text-gray-300 hover:text-green-500"><CheckCircle size={16}/></button></div></div>)}</div>
                    <div><h2 className="text-gray-400 font-bold text-xs uppercase mb-3 ml-1">Bills Due</h2>{unpaid.map(b => <BillCardItem key={b.id} bill={b} isPaid={false} dr={dr} onPayBill={onPayBill} onEditBill={onEditBill} />)}</div>{paid.length > 0 && (<div className="opacity-60"><h2 className="text-gray-400 font-bold text-xs uppercase mb-3 ml-1">Paid</h2>{paid.map(b => <BillCardItem key={b.id} bill={b} isPaid={true} dr={dr} onPayBill={onPayBill} onEditBill={onEditBill} />)}</div>)}
                </div>
            );
        }

        const GoalsView = ({ goals, user, onUpdate, onDelete }) => {
            const [filter, setFilter] = useState('mine');
            const filteredGoals = goals.filter(g => filter==='ours'?g.type==='shared':(filter==='mine'?g.type==='personal'&&g.owner===user:g.type==='personal'&&g.owner!==user));
            const GoalSection = ({ title, items }) => {
                const [open, setOpen] = useState(true);
                if (items.length === 0) return null;
                return (
                    <div className="mb-4">
                        <button onClick={() => setOpen(!open)} className="flex items-center justify-between w-full text-left font-bold text-gray-800 text-sm mb-2 bg-gray-100 p-2 rounded-lg"><span>{title}</span>{open ? <ChevronRight size={16} className="rotate-90"/> : <ChevronRight size={16}/>}</button>
                        {open && <div className="space-y-3 pl-1">{items.map(g => <GoalItem key={g.id} goal={g} onUpdate={onUpdate} onDelete={onDelete} user={user} />)}</div>}
                    </div>
                );
            };
            return (
                <div className="space-y-6">
                    <div className="flex bg-gray-200 p-1 rounded-xl"><button onClick={()=>setFilter('mine')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${filter==='mine'?'bg-white shadow text-gray-800':'text-gray-500'}`}>Me</button><button onClick={()=>setFilter('ours')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${filter==='ours'?'bg-white shadow text-gray-800':'text-gray-500'}`}>Us</button><button onClick={()=>setFilter('partner')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${filter==='partner'?'bg-white shadow text-gray-800':'text-gray-500'}`}>Them</button></div>
                    {GOAL_TIMEFRAMES.map(tf => (<GoalSection key={tf} title={tf} items={filteredGoals.filter(g => g.timeframe === tf)} />))}
                </div>
            );
        }

        const CalendarView = ({ events, user, onAck, onDelete }) => {
            const [date, setDate] = useState(new Date()); const [sel, setSel] = useState(new Date());
            const daysInMonth = new Date(date.getFullYear(), date.getMonth()+1, 0).getDate(); const startDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay(); const days = []; for(let i=0;i<startDay;i++) days.push(<div key={`e-${i}`}></div>);
            for(let i=1;i<=daysInMonth;i++) { const d = new Date(date.getFullYear(), date.getMonth(), i); const evs = events.filter(e=>{if(!e.date)return false; const ed=new Date(e.date); return ed.getDate()===i && ed.getMonth()===date.getMonth() && ed.getFullYear()===date.getFullYear();}); const isSel = d.getDate()===sel.getDate() && d.getMonth()===sel.getMonth(); days.push(<div key={i} onClick={()=>setSel(d)} className={`h-12 border-t border-gray-50 flex flex-col items-center justify-center cursor-pointer ${isSel?'bg-pink-50':''}`}><span className="text-sm font-bold text-gray-700">{i}</span><div className="flex gap-0.5 mt-1">{evs.slice(0,3).map(e=><div key={e.id} className={`w-1.5 h-1.5 rounded-full ${e.type==='shared'?'bg-pink-400':(e.owner==='Ducky'?'bg-yellow-400':'bg-blue-400')}`}></div>)}</div></div>); }
            const selEvs = events.filter(e=>{if(!e.date)return false; const ed=new Date(e.date); return ed.getDate()===sel.getDate() && ed.getMonth()===sel.getMonth() && ed.getFullYear()===sel.getFullYear();});
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><div className="flex justify-between items-center mb-4"><button onClick={()=>setDate(new Date(date.getFullYear(),date.getMonth()-1,1))}><ChevronLeft size={20}/></button><h2 className="text-lg font-black">{date.toLocaleString('default',{month:'long',year:'numeric'})}</h2><button onClick={()=>setDate(new Date(date.getFullYear(),date.getMonth()+1,1))}><ChevronRight size={20}/></button></div><div className="grid grid-cols-7 text-center mb-2">{['S','M','T','W','T','F','S'].map(d=><span key={d} className="text-[10px] font-bold text-gray-400">{d}</span>)}</div><div className="grid grid-cols-7 text-center">{days}</div></div>
                    <div><h3 className="text-gray-400 font-bold text-xs uppercase mb-3 ml-1">{sel.toLocaleDateString()}</h3><div className="space-y-3">{selEvs.map(e=><div key={e.id} className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-pink-400 flex justify-between items-center"><div><div className="font-bold text-gray-800">{e.title}</div><div className="text-xs text-gray-500 flex items-center gap-1"><Clock size={12}/> {e.time}</div></div><div className="flex gap-2">{e.type==='shared'&&e.acks&&!e.acks[user]&&<button onClick={()=>onAck(e.id)} className="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold">Ack</button>}<button onClick={()=>onDelete(e.id)} className="text-gray-300"><Trash2 size={16}/></button></div></div>)}</div></div>
                </div>
            );
        }

        const RewardsView = ({ coupons, currentUser, onRedeem }) => {
            const myCoupons = coupons.filter(c => c.owner === currentUser && !c.isUsed);
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-purple-500 to-indigo-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden"><div className="relative z-10"><h2 className="text-2xl font-black mb-1">Your Wallet</h2><p className="opacity-80 text-sm">You have {myCoupons.length} coupons available.</p></div><Gift className="absolute -bottom-4 -right-4 text-white opacity-20" size={100} /></div>
                    <div className="grid grid-cols-1 gap-4">{myCoupons.length === 0 ? <div className="text-center py-10 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200"><p>No coupons yet!</p><p className="text-xs mt-1">Complete chores to earn them.</p></div> : myCoupons.map(coupon => (<div key={coupon.id} className="bg-white rounded-xl border-2 border-dashed border-indigo-200 p-4 flex items-center justify-between"><div><h3 className="font-bold text-gray-800">{coupon.title}</h3><p className="text-[10px] text-gray-400 uppercase tracking-wider mt-1">Valid forever</p></div><button onClick={() => onRedeem(coupon)} className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100">Use</button></div>))}</div>
                </div>
            );
        }

        const CastleView = ({ chores, completed, events, goals, bills, ious, activities, jokes, notes, user, settings, profiles, onOpenSettings, onToggleChore, onOpenMeeting, onOpenHistory, announcements }) => {
            const [statsTimeframe, setStatsTimeframe] = useState('weekly');
            const stats = useMemo(() => calculateKingdomStats(statsTimeframe, completed, bills, goals, activities, events, jokes, notes, ious), [statsTimeframe, completed, bills, goals, activities, events, jokes, notes, ious]);
            const duckyScore = stats.Ducky.chores + (stats.Ducky.money / DOMINANCE_WEIGHTS.MONEY_TO_POINT_RATIO);
            const pipsScore = stats.Pips.chores + (stats.Pips.money / DOMINANCE_WEIGHTS.MONEY_TO_POINT_RATIO);
            const totalScore = duckyScore + pipsScore;
            const diff = Math.abs(duckyScore - pipsScore);
            const isBalanced = diff < DOMINANCE_WEIGHTS.EQUALITY_THRESHOLD;
            const balanceZoneWidth = totalScore > 0 ? (DOMINANCE_WEIGHTS.EQUALITY_THRESHOLD / totalScore) * 100 : 100;
            const duckyPercent = totalScore > 0 ? (duckyScore / totalScore) * 100 : 50;
            
            // Safety check for profiles loading
            if (!profiles.Ducky || !profiles.Pips) return <div className="flex justify-center p-10 text-gray-400 animate-pulse">Loading Kingdom...</div>;

            let rulerName = "The Alliance", rulerFlag = settings.kingdomFlag || 'üè∞', rulerBg = "bg-purple-50", rulerColor = "text-purple-600", rulerPronouns = 'they';
            if (!isBalanced) {
                if (duckyScore > pipsScore) { rulerName = profiles.Ducky?.name || 'Ducky'; rulerFlag = settings.duckyFlag || 'üê•'; rulerBg = "bg-yellow-50"; rulerColor = "text-yellow-600"; rulerPronouns = profiles.Ducky?.pronouns || 'they'; } 
                else { rulerName = profiles.Pips?.name || 'Pips'; rulerFlag = settings.pipsFlag || 'üê¶'; rulerBg = "bg-blue-50"; rulerColor = "text-blue-600"; rulerPronouns = profiles.Pips?.pronouns || 'they'; }
            }
            const rulerTitle = isBalanced ? "Dual Monarchy" : `${ROYAL_TITLES.ruler[rulerPronouns]} of the ${statsTimeframe === 'weekly' ? 'Week' : (statsTimeframe === 'monthly' ? 'Month' : 'Year')}`;
            const activeAnnouncement = announcements.find(a => a.active && a.from !== user);

            const CourtCard = ({ title, duckyVal, pipsVal, type, icon: Icon, color }) => {
                const duckyWin = duckyVal > pipsVal;
                const pipsWin = pipsVal > duckyVal;
                let winnerName = "Shared Duty", winnerTitle = "Co-Regents", winnerColor = "text-gray-400";
                if (duckyWin) { winnerName = profiles.Ducky?.name; winnerTitle = ROYAL_TITLES[type][profiles.Ducky?.pronouns || 'they']; winnerColor = "text-yellow-600"; } 
                else if (pipsWin) { winnerName = profiles.Pips?.name; winnerTitle = ROYAL_TITLES[type][profiles.Pips?.pronouns || 'they']; winnerColor = "text-blue-600"; }
                return (
                    <div className={`bg-white rounded-2xl p-3 border border-gray-100 shadow-sm flex flex-col justify-between h-32 relative overflow-hidden`}>
                        <div className={`absolute top-0 right-0 p-2 opacity-10 ${color}`}><Icon size={48} /></div>
                        <div><h4 className="text-[10px] font-black uppercase text-gray-400 tracking-wider mb-1">{title}</h4><div className={`font-black text-sm leading-tight ${winnerColor}`}>{winnerTitle}</div><div className="text-xs font-bold text-gray-600 mt-0.5">{winnerName}</div></div>
                        <div className="flex gap-2 mt-2 items-end"><div className="flex-1"><div className="text-[10px] font-bold text-yellow-600 mb-0.5">{profiles.Ducky?.icon} {type==='finance'?'$':''}{Math.round(duckyVal)}</div><div className="h-1.5 bg-gray-100 rounded-full overflow-hidden"><div style={{width: `${(duckyVal/(Math.max(duckyVal,pipsVal)||1))*100}%`}} className="h-full bg-yellow-400"></div></div></div><div className="flex-1"><div className="text-[10px] font-bold text-blue-600 mb-0.5 text-right">{type==='finance'?'$':''}{Math.round(pipsVal)} {profiles.Pips?.icon}</div><div className="h-1.5 bg-gray-100 rounded-full overflow-hidden flex justify-end"><div style={{width: `${(pipsVal/(Math.max(duckyVal,pipsVal)||1))*100}%`}} className="h-full bg-blue-400"></div></div></div></div>
                    </div>
                );
            };

            return (
                <div className="space-y-6">
                    {activeAnnouncement && (<div className="bg-purple-100 border-2 border-purple-300 p-4 rounded-2xl flex items-start gap-3 shadow-md animate-pop"><Megaphone className="text-purple-600 shrink-0" size={24} /><div><h4 className="font-black text-purple-800 text-xs uppercase mb-1">Royal Decree from {profiles[activeAnnouncement.from]?.name}</h4><p className="text-purple-900 font-bold text-sm">{activeAnnouncement.message}</p></div></div>)}
                    <div className="flex bg-gray-100 p-1 rounded-xl mx-6 -mb-3 relative z-20">{['weekly', 'monthly', 'yearly'].map(t => (<button key={t} onClick={() => setStatsTimeframe(t)} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-all ${statsTimeframe === t ? 'bg-white shadow-sm text-gray-800 scale-105' : 'text-gray-400'}`}>{t}</button>))}</div>
                    <div onClick={onOpenHistory} className={`bg-white rounded-[2.5rem] p-6 pt-8 text-center relative overflow-hidden border-4 border-white shadow-lg cursor-pointer hover:shadow-xl transition-shadow active:scale-95 transition-transform`}><button onClick={(e) => { e.stopPropagation(); onOpenSettings(); }} className="absolute top-4 right-4 z-50 text-gray-300 hover:text-gray-500 bg-gray-50 p-2 rounded-full shadow-sm active:scale-95"><Settings size={18}/></button><div className="h-32 flex items-end justify-center mb-4 relative"><div className="absolute top-0 flex flex-col items-center animate-float"><div className={`text-5xl filter drop-shadow-md`}>{rulerFlag}</div><div className="h-10 w-1 bg-gray-300"></div></div><svg viewBox="0 0 100 60" className={`w-48 h-auto ${isBalanced ? 'text-purple-300' : (duckyScore > pipsScore ? 'text-yellow-200' : 'text-blue-200')} fill-current transition-colors duration-500`}><path d="M10 60 V30 L5 30 L5 20 L15 10 L25 20 L25 30 L20 30 V60 H10 Z" /><path d="M80 60 V30 L75 30 L75 20 L85 10 L95 20 L95 30 L90 30 V60 H80 Z" /><path d="M20 60 V40 H80 V60 Z" /><path d="M40 60 V45 A10 10 0 0 1 60 45 V60 Z" fill="#4b5563" /></svg></div><h2 className="text-3xl font-black text-gray-800 tracking-tight">{settings.name || 'Our Kingdom'}</h2><div className={`inline-block px-3 py-1 rounded-full text-xs font-black uppercase tracking-widest mt-2 ${rulerBg} ${rulerColor}`}>{rulerTitle} {rulerName !== "The Alliance" ? rulerName : ""}</div><div className="mt-6 px-1"><div className="flex justify-between text-[10px] font-bold text-gray-400 uppercase mb-1"><span className="text-yellow-600">{profiles.Ducky?.name} ({Math.round(duckyScore)})</span><span className="text-blue-600">{profiles.Pips?.name} ({Math.round(pipsScore)})</span></div><div className="h-5 w-full bg-gray-100 rounded-full overflow-hidden flex shadow-inner relative"><div className="absolute top-0 bottom-0 bg-white/40 backdrop-blur-[2px] border-x-2 border-dashed border-gray-300 z-20 transition-all duration-500" style={{ left: `50%`, transform: 'translateX(-50%)', width: `${Math.min(balanceZoneWidth, 100)}%` }} /><div className="absolute top-0 bottom-0 w-0.5 bg-black/20 left-1/2 z-30 -translate-x-1/2"></div><div style={{ width: `${duckyPercent}%` }} className="bg-yellow-400 h-full transition-all duration-1000 relative"></div><div className="flex-1 bg-blue-400 h-full transition-all duration-1000 relative"></div></div><div className="flex justify-between items-center mt-1"><div className="text-[9px] text-gray-300 font-bold">Points</div><div className="text-[9px] text-gray-400 font-medium flex items-center gap-1"><Shield size={8}/> Balance Area <Shield size={8}/></div><div className="text-[9px] text-gray-300 font-bold">Points</div></div></div></div>
                    <button onClick={onOpenMeeting} className="w-full bg-gradient-to-r from-gray-800 to-black p-5 rounded-2xl shadow-lg flex items-center justify-between group hover:scale-[1.02] transition-transform"><div className="text-left"><h3 className="text-white font-black text-lg flex items-center gap-2"><Users size={20} className="text-pink-400"/> Daily Family Meeting</h3><p className="text-gray-400 text-xs mt-1">Check-in, Plan, & Connect</p></div><div className="bg-white/10 p-3 rounded-full group-hover:bg-white/20 transition-colors"><ArrowRight className="text-white" size={20}/></div></button>
                    <div><h3 className="text-gray-400 font-bold text-xs uppercase tracking-wider flex items-center gap-2 mb-3 ml-1"><Crown size={14}/> The Royal Court</h3><div className="grid grid-cols-2 gap-3"><CourtCard title="Finance" type="finance" icon={Coins} color="text-green-500" duckyVal={stats.Ducky.money} pipsVal={stats.Pips.money} /><CourtCard title="Deeds" type="chores" icon={Shield} color="text-orange-500" duckyVal={stats.Ducky.chores} pipsVal={stats.Pips.chores} /><CourtCard title="Planning" type="planning" icon={Scroll} color="text-purple-500" duckyVal={stats.Ducky.planning} pipsVal={stats.Pips.planning} /><CourtCard title="Provisions" type="shopping" icon={Store} color="text-pink-500" duckyVal={stats.Ducky.shopping} pipsVal={stats.Pips.shopping} /><CourtCard title="Entertainment" type="jester" icon={Smile} color="text-yellow-500" duckyVal={stats.Ducky.jokes} pipsVal={stats.Pips.jokes} /><CourtCard title="Wisdom" type="scribe" icon={StickyNote} color="text-blue-500" duckyVal={stats.Ducky.notes} pipsVal={stats.Pips.notes} /></div></div>
                </div>
            );
        };

        const JokesView = ({ jokes, onAdd, onDelete, user }) => {
            return (<div className="space-y-4"><div className="bg-yellow-100 rounded-2xl p-6 text-yellow-800 shadow-sm border-2 border-yellow-200 text-center mb-6"><Smile className="mx-auto mb-2 text-yellow-600" size={32} /><h2 className="text-xl font-black mb-1">Kingdom Jester</h2><p className="text-sm font-medium opacity-80">Who is the funniest of them all?</p></div><div className="space-y-4">{jokes.map((j) => (<div key={j.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 relative group"><div className="flex justify-between items-start mb-2"><span className="text-[10px] font-bold uppercase tracking-wider bg-gray-100 px-2 py-1 rounded-lg text-gray-500">Told by {j.who}</span><span className="text-2xl" title={JOKE_RATINGS[j.rating]?.label}>{JOKE_RATINGS[j.rating]?.emoji}</span></div><p className="text-lg font-bold text-gray-800 leading-snug">"{j.text}"</p><button onClick={() => onDelete(j.id)} className="absolute bottom-2 right-2 p-2 text-gray-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={16}/></button></div>))}{jokes.length === 0 && <div className="text-center py-10 text-gray-400"><p>No jokes yet. Tough crowd?</p></div>}</div><div className="h-20"></div></div>);
        };

        const NotesView = ({ notes, onAdd, onDelete, onEdit, user }) => {
            return (<div className="space-y-4"><div className="bg-blue-100 rounded-2xl p-6 text-blue-800 shadow-sm border-2 border-blue-200 text-center mb-6"><StickyNote className="mx-auto mb-2 text-blue-600" size={32} /><h2 className="text-xl font-black mb-1">Royal Scribe</h2><p className="text-sm font-medium opacity-80">Notes, ideas, and decrees.</p></div><div className="columns-2 gap-4 space-y-4">{notes.map((n) => (<div key={n.id} onClick={() => onEdit(n)} className="bg-yellow-50 p-4 rounded-xl shadow-sm border border-yellow-100 break-inside-avoid relative group transform rotate-1 hover:rotate-0 transition-transform cursor-pointer"><h3 className="font-black text-gray-800 mb-1 leading-tight">{n.title}</h3><p className="text-xs text-gray-600 font-medium leading-relaxed whitespace-pre-wrap max-h-32 overflow-hidden">{n.content || (n.blocks ? n.blocks.map(b => b.text).join(' ') : '')}</p><div className="flex justify-between items-center mt-3 pt-2 border-t border-yellow-200/50"><span className="text-[10px] font-bold text-yellow-600 uppercase">{n.createdBy}</span><div className="text-yellow-400 text-[10px] font-bold">Edit</div></div></div>))}</div>{notes.length === 0 && <div className="text-center py-10 text-gray-400"><p>No notes pinned.</p></div>}<div className="h-20"></div></div>);
        };

        const MyListView = ({ chores, onToggle, onDelete, user, progress, threshold, onOpenRecurring }) => { 
            const pretty = chores.filter(c => c.isPrettyPlease); const regular = chores.filter(c => !c.isPrettyPlease);
            const sort = (list) => list.sort((a, b) => { if (!a.dueDate) return 1; if (!b.dueDate) return -1; return new Date(a.dueDate) - new Date(b.dueDate); });
            return (
                <div className="space-y-6">
                    <ProgressBar current={progress} max={threshold || 5} label="Next Coupon" color={user === 'Ducky' ? 'bg-yellow-400' : 'bg-blue-400'} />
                    {pretty.length > 0 && <div className="bg-pink-50 rounded-2xl p-4 border-2 border-pink-200 shadow-sm"><h2 className="text-pink-600 font-bold flex items-center gap-2 mb-3 text-sm uppercase tracking-wider"><Sparkles size={16} /> Pretty Please</h2><div className="space-y-3">{pretty.map(chore => <ChoreItem key={chore.id} chore={chore} onToggle={onToggle} onDelete={onDelete} isPretty={true} />)}</div></div>}
                    <div><div className="flex justify-between items-center mb-3 ml-1"><h2 className="text-gray-400 font-bold text-xs uppercase tracking-wider">Current List</h2><button onClick={onOpenRecurring} className="flex items-center gap-1 text-[10px] font-bold bg-gray-100 text-gray-500 px-2 py-1 rounded-lg hover:bg-gray-200 transition-colors"><Repeat size={10}/> Manage Recurring</button></div>{regular.length === 0 ? <div className="text-center py-12 opacity-50"><div className="text-4xl mb-2">üéâ</div><p className="text-sm font-medium">All done!</p></div> : <div className="space-y-3">{sort(regular).map(chore => <ChoreItem key={chore.id} chore={chore} onToggle={onToggle} onDelete={onDelete} />)}</div>}</div>
                </div>
            );
        }

        const ShoppingListView = ({ items, onAdd, onToggle, onDelete, onFinishShopping, isShoppingMode, setShoppingMode, user }) => {
            const sortedItems = [...items].sort((a, b) => { const pMap = { 'high': 0, 'normal': 1, 'treat': 2 }; const pA = pMap[a.priority || 'normal']; const pB = pMap[b.priority || 'normal']; if (pA !== pB) return pA - pB; return 0; });
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 relative overflow-hidden"><div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><ShoppingCart size={20} className="text-orange-400"/> {isShoppingMode ? 'Shopping Mode' : 'Shopping List'}</h2><button onClick={() => { if(isShoppingMode && items.some(i=>i.completed)) onFinishShopping(0); else setShoppingMode(!isShoppingMode); }} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all shadow-sm ${isShoppingMode ? 'bg-green-500 text-white' : 'bg-black text-white'}`}>{isShoppingMode ? 'Finish Shopping' : 'Start Shopping'}</button></div>{!isShoppingMode && <button onClick={() => onAdd()} className="w-full py-3 mb-4 bg-orange-50 border-2 border-dashed border-orange-200 rounded-2xl text-orange-500 font-bold text-sm hover:bg-orange-100 transition-colors flex items-center justify-center gap-2"><Plus size={18}/> Add Item</button>}<div className="space-y-2">{items.length===0&&<p className="text-center text-gray-300 text-xs py-4">Fridge is full!</p>}{sortedItems.map(item => { let styleClass = "border-gray-100"; let icon = null; if (item.priority === 'high') { styleClass = "border-red-100 bg-red-50"; icon = <AlertOctagon size={16} className="text-red-500" />; } else if (item.priority === 'treat') { const isDucky = item.owner === 'Ducky'; styleClass = isDucky ? "border-yellow-100 bg-yellow-50" : "border-blue-100 bg-blue-50"; icon = <Cookie size={16} className={isDucky ? "text-yellow-600" : "text-blue-600"} />; } return (<div key={item.id} className={`flex items-center gap-3 p-3 rounded-xl border-2 transition-all ${styleClass} ${isShoppingMode ? (item.completed ? 'opacity-50 grayscale' : '') : 'hover:shadow-sm group'}`}><div onClick={()=>onToggle(item.id, !item.completed)} className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center cursor-pointer transition-colors ${item.completed ? 'bg-green-500 border-green-500' : 'border-gray-300 bg-white'}`}>{item.completed && <CheckCircle size={16} className="text-white"/>}</div><span className={`flex-1 text-sm font-medium flex items-center gap-2 ${item.completed ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{icon} {item.text}</span>{!isShoppingMode && <button onClick={()=>onDelete(item.id)} className="text-gray-300 hover:text-red-400 opacity-0 group-hover:opacity-100"><Trash2 size={16}/></button>}</div>); })}</div></div>
                </div>
            );
        }

        const AssignView = ({ chores, onVote, profile }) => {
            const [current, setCurrent] = useState(0); const [dir, setDir] = useState(null); const chore = chores[current]; const swipe = (d) => { setDir(d); setTimeout(() => { if (chore) onVote(chore.id, d); setDir(null); setCurrent(0); }, 300); };
            if (chores.length === 0) return <div className="flex flex-col items-center justify-center h-full text-center text-gray-400"><div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4"><CheckCircle size={40} className="text-gray-300" /></div><p>Caught up!</p></div>;
            return (<div className="flex flex-col items-center justify-center h-full relative"><h2 className="absolute top-0 text-xs font-bold text-gray-400 uppercase tracking-widest mb-8">Swipe to Assign</h2><div className="relative w-full max-w-xs h-80 perspective-1000">{chores.length > 1 && <div className="absolute top-4 left-4 w-full h-full bg-white border border-gray-100 rounded-3xl shadow-sm z-0 transform scale-95 opacity-50"></div>}{chore && <div className={`absolute top-0 left-0 w-full h-full bg-white border border-gray-200 rounded-3xl shadow-xl z-10 flex flex-col items-center justify-center p-8 text-center transition-all duration-300 ease-out transform ${dir === 'left' ? '-translate-x-full rotate-[-20deg] opacity-0' : ''} ${dir === 'right' ? 'translate-x-full rotate-[20deg] opacity-0' : ''}`}>{chore.isPrettyPlease && <Sparkles className="text-pink-400 mb-4" size={32} />}<h3 className="text-2xl font-black text-gray-800 mb-2">{chore.title}</h3><div className="absolute bottom-8 w-full px-8 flex justify-between text-xs font-bold uppercase tracking-wider text-gray-300"><span className="text-blue-300">{'< Pips'}</span><span className="text-yellow-400">{'Ducky >'}</span></div></div>}</div><div className="flex gap-8 mt-12"><button onClick={() => swipe('left')} className="w-16 h-16 bg-white border-2 border-blue-100 text-blue-400 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-all"><ArrowLeft size={24} /></button><button onClick={() => swipe('right')} className="w-16 h-16 bg-white border-2 border-yellow-100 text-yellow-500 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-all"><ArrowRight size={24} /></button></div></div>);
        }

        const DateNightView = ({ activeDate, history, progress, onLog, onUpdateDate, onCompleteDate, resetProgress, threshold, user, completed, bills, goals, activities, events, jokes, notes, ious, profiles, settings }) => {
            const stats = useMemo(() => calculateKingdomStats('monthly', completed, bills, goals, activities, events, jokes, notes, ious), [completed, bills, goals, activities, events, jokes, notes, ious]);
            const getWinner = (duckyVal, pipsVal) => { if (duckyVal > pipsVal) return 'Ducky'; if (pipsVal > duckyVal) return 'Pips'; return null; };
            const roles = {
                treasurer: getWinner(stats.Ducky.money, stats.Pips.money), steward: getWinner(stats.Ducky.chores, stats.Pips.chores), vizier: getWinner(stats.Ducky.planning, stats.Pips.planning), merchant: getWinner(stats.Ducky.shopping, stats.Pips.shopping), jester: getWinner(stats.Ducky.jokes, stats.Pips.jokes), scribe: getWinner(stats.Ducky.notes, stats.Pips.notes),
                ruler: getWinner(stats.Ducky.chores + (stats.Ducky.money / DOMINANCE_WEIGHTS.MONEY_TO_POINT_RATIO), stats.Pips.chores + (stats.Pips.money / DOMINANCE_WEIGHTS.MONEY_TO_POINT_RATIO))
            };
            const startNewDate = () => { const target = threshold || DEFAULT_CHORES_PER_DATENIGHT; if (progress < target) return; onLog({ status: 'budgeting', stageData: { budgetInputs: {} }, createdAt: new Date().toISOString() }); resetProgress(target); };

            if (!activeDate) {
                const target = threshold || DEFAULT_CHORES_PER_DATENIGHT;
                const isUnlocked = progress >= target;
                return (
                    <div className="space-y-8">
                        <div className="text-center bg-white p-6 rounded-3xl shadow-sm border border-gray-100"><h2 className="text-lg font-black text-gray-800 mb-4">Date Night Progress</h2><div className="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center"><svg className="w-full h-full transform -rotate-90"><circle cx="80" cy="80" r="70" stroke="#f3f4f6" strokeWidth="12" fill="none" /><circle cx="80" cy="80" r="70" stroke="#ec4899" strokeWidth="12" fill="none" strokeDasharray="440" strokeDashoffset={440 - (440 * Math.min(progress / target, 1))} className="transition-all duration-1000" /></svg><div className="absolute inset-0 flex flex-col items-center justify-center"><span className="text-3xl font-black text-gray-800">{Math.min(progress, target)}</span><span className="text-xs text-gray-400 font-bold uppercase">of {target}</span></div></div><button onClick={startNewDate} disabled={!isUnlocked} className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all ${isUnlocked ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white hover:scale-105 active:scale-95' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}>{isUnlocked ? "üé≤ Start Planning!" : "Keep Working Together!"}</button></div>
                        <div><h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider mb-4">Memory Lane</h3><div className="space-y-4">{history.map(item => (<div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100"><div className="flex justify-between items-start mb-2"><div className="flex gap-2"><span className="bg-pink-100 text-pink-600 text-[10px] font-bold px-2 py-1 rounded-full">{item.vibe || 'Fun'}</span><span className="bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-1 rounded-full">{item.food || 'Yum'}</span></div><span className="text-[10px] text-gray-400">{new Date(item.createdAt || item.date).toLocaleDateString()}</span></div><h4 className="font-bold text-gray-800 text-lg mb-1">{item.activity} @ {item.place || 'Somewhere'}</h4>{item.review && <p className="text-sm text-gray-600 italic">"{item.review}"</p>}{item.photo && <img src={item.photo} alt="Memory" className="mt-3 rounded-lg w-full h-32 object-cover" />}</div>))}</div></div>
                    </div>
                );
            }

            if (activeDate.status === 'budgeting') {
                const inputs = activeDate.stageData?.budgetInputs || {};
                const myInput = inputs[user];
                const partner = user === 'Ducky' ? 'Pips' : 'Ducky';
                const partnerInput = inputs[partner];
                const saveBudget = (val) => { const newData = { ...inputs, [user]: val }; onUpdateDate(activeDate.id, { status: (newData.Ducky && newData.Pips) ? 'parameters' : 'budgeting', stageData: { ...activeDate.stageData, budgetInputs: newData } }); };
                return (<div className="bg-white p-6 rounded-3xl shadow-lg border-2 border-green-100 text-center"><PiggyBank className="mx-auto text-green-500 mb-4" size={48} /><h2 className="text-2xl font-black text-gray-800 mb-2">Budgeting</h2><p className="text-gray-500 mb-6 text-sm">How much can you chip in?</p>{myInput ? (<div className="bg-green-50 p-4 rounded-xl mb-4 text-green-700 font-bold">You pledged ${myInput}</div>) : (<div className="flex gap-2 mb-4"><input type="number" placeholder="$" id="budgetInput" className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 font-bold text-lg" /><button onClick={() => { const val = parseFloat(document.getElementById('budgetInput').value); if(val >= 0) saveBudget(val); }} className="bg-green-500 text-white px-4 rounded-xl font-bold">Save</button></div>)}<p className="text-xs text-gray-400 uppercase font-bold">{partner}: {partnerInput ? "Ready" : "Waiting..."}</p></div>);
            }

            if (activeDate.status === 'parameters') {
                const assignments = activeDate.stageData?.parameterAssignments || { budget: roles.treasurer || 'Ducky', duration: roles.steward || 'Pips', time: roles.vizier || 'Ducky', food: roles.merchant || 'Pips' };
                const params = activeDate.stageData?.parameters || {};
                const isDone = params.budget && params.duration && params.time && params.food;
                const updateParam = (key, val) => { onUpdateDate(activeDate.id, { stageData: { ...activeDate.stageData, parameters: { ...params, [key]: val } } }); };
                const Field = ({ label, keyName, roleTitle, assignedTo, type, options }) => {
                    const isMe = assignedTo === user || (assignedTo === 'Tie' && user === 'Ducky');
                    const val = params[keyName];
                    return (<div className={`p-4 rounded-xl border-2 mb-3 ${val ? 'bg-gray-50 border-gray-100' : 'bg-white border-blue-100'}`}><div className="flex justify-between mb-2"><span className="text-xs font-black uppercase text-gray-400">{label}</span><span className="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-0.5 rounded-full">{assignedTo === user ? 'You' : assignedTo} ({roleTitle})</span></div>{isMe ? (val ? <div className="font-bold text-lg text-gray-800">{val}</div> : (type === 'select' ? (<div className="flex flex-wrap gap-2">{options.map(opt => <button key={opt} onClick={() => updateParam(keyName, opt)} className="bg-gray-100 hover:bg-blue-100 px-3 py-1 rounded-lg text-sm font-bold">{opt}</button>)}</div>) : (<input type="text" className="w-full bg-gray-50 border-2 border-gray-200 rounded-lg p-2 font-bold" onBlur={(e) => updateParam(keyName, e.target.value)} placeholder="Type & click out..." />))) : (<div className="text-sm font-bold text-gray-400 italic">{val || "Deciding..."}</div>)}</div>);
                };
                return (<div className="space-y-4"><h2 className="text-xl font-black text-center mb-4">Planning Committee</h2><Field label="Total Budget" keyName="budget" assignedTo={assignments.budget} roleTitle="Treasurer" /><Field label="Duration" keyName="duration" assignedTo={assignments.duration} roleTitle="Steward" type="select" options={['1 Hour', '2 Hours', 'All Night', 'Weekend']} /><Field label="Start Time" keyName="time" assignedTo={assignments.time} roleTitle="Vizier" type="select" options={['5:00 PM', '6:00 PM', '7:00 PM', '8:00 PM']} /><Field label="Cuisine" keyName="food" assignedTo={assignments.food} roleTitle="Merchant" type="select" options={DATE_FOODS} />{isDone && <button onClick={() => onUpdateDate(activeDate.id, { status: 'activity' })} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-cute mt-4">All Set! Next Step</button>}</div>);
            }

            if (activeDate.status === 'activity') {
                const ruler = roles.ruler, isMe = ruler === user, isTie = !ruler;
                const suggestions = activeDate.stageData?.suggestions || {};
                const saveActivity = (actv) => { onUpdateDate(activeDate.id, { status: 'twist', finalDetails: { ...activeDate.stageData?.parameters, activity: actv, totalBudget: activeDate.stageData?.parameters?.budget, split: activeDate.stageData?.budgetInputs } }); };
                const handleSuggestion = (val) => { onUpdateDate(activeDate.id, { stageData: { ...activeDate.stageData, suggestions: { ...suggestions, [user]: val } } }); };
                const rollForIt = () => { const acts = [suggestions.Ducky, suggestions.Pips]; const winner = acts[Math.floor(Math.random() * acts.length)]; if(winner) saveActivity(winner); };

                if (isTie) {
                    const bothSuggested = suggestions.Ducky && suggestions.Pips;
                    return (<div className="bg-white p-6 rounded-3xl text-center shadow-lg border-2 border-purple-100"><Crown className="mx-auto text-purple-400 mb-2" size={32} /><h2 className="text-xl font-black mb-4">Balanced Kingdom!</h2><p className="text-sm text-gray-500 mb-6">Both of you suggest an activity, then fate decides.</p>{!suggestions[user] ? (<div className="mb-4"><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 font-bold" placeholder="I suggest..." onBlur={(e) => handleSuggestion(e.target.value)} /></div>) : <div className="bg-purple-50 p-3 rounded-xl mb-4 font-bold text-purple-800">You suggested: {suggestions[user]}</div>}{bothSuggested ? (<button onClick={rollForIt} className="w-full bg-purple-500 text-white py-3 rounded-xl font-black shadow-cute">Roll the Dice!</button>) : <p className="text-xs text-gray-400 uppercase font-bold">Waiting for partner...</p>}</div>);
                } else {
                    return (<div className="bg-white p-6 rounded-3xl text-center shadow-lg border-2 border-yellow-100"><Crown className="mx-auto text-yellow-500 mb-2" size={48} /><h2 className="text-xl font-black mb-2">{profiles[ruler]?.name} Reigns!</h2><p className="text-sm text-gray-500 mb-6">As the dominant ruler, you choose the activity.</p>{isMe ? (<div className="space-y-4"><input id="actInput" className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-4 font-bold text-lg" placeholder="e.g. Bowling & Tacos" /><button onClick={() => { const val = document.getElementById('actInput').value; if(val) saveActivity(val); }} className="w-full bg-black text-white py-3 rounded-xl font-black shadow-cute">Decide Decree</button></div>) : (<div className="p-4 bg-gray-50 rounded-xl italic text-gray-400">Waiting for the Monarch's decision...</div>)}</div>);
                }
            }

            if (activeDate.status === 'twist') {
                const jester = roles.jester || (roles.ruler === 'Ducky' ? 'Pips' : 'Ducky'), isMe = jester === user;
                const saveTwist = (twist) => { onUpdateDate(activeDate.id, { status: 'planned', finalDetails: { ...activeDate.finalDetails, twist } }); };
                return (<div className="bg-white p-6 rounded-3xl text-center shadow-lg border-2 border-yellow-200"><Smile className="mx-auto text-yellow-500 mb-2" size={48} /><h2 className="text-xl font-black mb-2">The Jester's Twist</h2><p className="text-sm text-gray-500 mb-6">{profiles[jester]?.name} gets to add a funny rule.</p>{isMe ? (<div><textarea id="twistInput" className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-4 font-bold text-sm h-24 mb-4" placeholder="e.g. Must hold hands..." /><div className="flex gap-2"><button onClick={() => saveTwist("No Twist")} className="flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold">Skip</button><button onClick={() => { const val = document.getElementById('twistInput').value; if(val) saveTwist(val); }} className="flex-1 bg-yellow-500 text-white py-3 rounded-xl font-black shadow-cute">Add Twist</button></div></div>) : (<div className="p-4 bg-gray-50 rounded-xl italic text-gray-400">The Jester is thinking...</div>)}</div>);
            }

            if (activeDate.status === 'planned') {
                const d = activeDate.finalDetails;
                return (<div className="space-y-6"><div className="bg-white p-6 rounded-[2.5rem] shadow-xl border-4 border-white text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-pink-400 to-purple-500"></div><h2 className="text-2xl font-black text-gray-800 mb-6 mt-2">Tonight's Plan</h2><div className="grid grid-cols-2 gap-4 mb-6"><div className="bg-gray-50 p-3 rounded-2xl"><span className="block text-[10px] font-black uppercase text-gray-400">Activity</span><span className="font-black text-gray-800">{d.activity}</span></div><div className="bg-gray-50 p-3 rounded-2xl"><span className="block text-[10px] font-black uppercase text-gray-400">Food</span><span className="font-black text-gray-800">{d.food}</span></div><div className="bg-gray-50 p-3 rounded-2xl"><span className="block text-[10px] font-black uppercase text-gray-400">Time</span><span className="font-black text-gray-800">{d.time} ({d.duration})</span></div><div className="bg-gray-50 p-3 rounded-2xl"><span className="block text-[10px] font-black uppercase text-gray-400">Budget</span><span className="font-black text-gray-800">${d.totalBudget}</span></div></div>{d.twist && (<div className="bg-yellow-50 p-4 rounded-2xl border-2 border-yellow-100 mb-6 transform -rotate-1"><span className="block text-[10px] font-black uppercase text-yellow-500 mb-1">Jester's Twist</span><span className="font-black text-yellow-800 text-lg">"{d.twist}"</span></div>)}<button onClick={() => onUpdateDate(activeDate.id, { status: 'review' })} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-cute hover:scale-105 transition-transform">Mark Complete</button></div></div>);
            }

            if (activeDate.status === 'review') {
                const scribe = roles.scribe || 'Ducky', isMe = scribe === user;
                const [review, setReview] = useState(''); const [photo, setPhoto] = useState(null);
                const handlePhotoChange = (e) => { const file = e.target.files?.[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setPhoto(reader.result); reader.readAsDataURL(file); } };
                const finish = () => { onCompleteDate(activeDate.id, { status: 'completed', review, photo, activity: activeDate.finalDetails.activity, place: activeDate.finalDetails.place, food: activeDate.finalDetails.food, date: activeDate.createdAt }); };
                return (<div className="bg-white p-6 rounded-3xl text-center shadow-lg border-2 border-blue-100"><Camera className="mx-auto text-blue-500 mb-2" size={48} /><h2 className="text-xl font-black mb-2">Memory Lane</h2><p className="text-sm text-gray-500 mb-6">{profiles[scribe]?.name}, document this memory!</p>{isMe ? (<div className="space-y-4"><textarea className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 text-sm font-medium h-32" placeholder="How was it?" value={review} onChange={e => setReview(e.target.value)} /><label className="flex items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer hover:bg-gray-50 bg-white">{photo ? <img src={photo} alt="Preview" className="h-full w-full object-cover rounded-2xl" /> : <div className="text-gray-400 font-bold text-xs">Add Photo</div>}<input type="file" accept="image/*" className="hidden" onChange={handlePhotoChange} /></label><button onClick={finish} className="w-full bg-blue-500 text-white py-3 rounded-xl font-black shadow-cute">Save Memory</button></div>) : (<div className="p-4 bg-gray-50 rounded-xl italic text-gray-400">Waiting for the Scribe...</div>)}</div>);
            }
            return null;
        };

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [tab, setTab] = useState('castle');
            const [chores, setChores] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [dates, setDates] = useState([]);
            const [bills, setBills] = useState([]);
            const [ious, setIous] = useState([]);
            const [goals, setGoals] = useState([]);
            const [events, setEvents] = useState([]);
            const [shop, setShop] = useState([]);
            const [activities, setActivities] = useState([]);
            const [announcements, setAnnouncements] = useState([]);
            const [jokes, setJokes] = useState([]);
            const [notes, setNotes] = useState([]);
            const [income, setIncome] = useState({ ducky: 0, pips: 0 });
            const [castle, setCastle] = useState({ name: 'Our Kingdom', kingdomFlag: 'üè∞', duckyFlag: 'üê•', pipsFlag: 'üê¶' });
            const [profiles, setProfiles] = useState({});
            const [settings, setSettings] = useState({});
            const [modals, setModals] = useState({});
            const [conflict, setConflict] = useState(null);
            const [redeem, setRedeem] = useState(null);
            const [selectedBill, setSelectedBill] = useState(null);
            const [isShoppingMode, setShoppingMode] = useState(false);
            const [selectedIOU, setSelectedIOU] = useState(null);
            const [dataLoaded, setDataLoaded] = useState({ chores: false, goals: false });
            const [editingNote, setEditingNote] = useState(null);
            const [editingBill, setEditingBill] = useState(null);
            const [needsOnboarding, setNeedsOnboarding] = useState(false);
            const [subscription, setSubscription] = useState({ status: 'inactive', debug: 'Init' });
            const [portalLoading, setPortalLoading] = useState(false); // New state

            const processedHabitsRef = React.useRef(new Set());

            const toggleModal = (m, v) => setModals({...modals, [m]: v});

            useEffect(() => {
                // Removed signInAnonymously to ensure users create accounts with emails for Stripe
                return onAuthStateChanged(auth, (u) => { setUser(u); if(u) setProfile(localStorage.getItem('ducky_pips_profile')); });
            }, []);

            useEffect(() => {
                if (!user) return;
                const subs = [];
                const basePath = `kingdoms/${user.uid}`;

                // Check Init
                subs.push(onSnapshot(doc(db, basePath, 'settings', 'castle'), (s) => {
                    if (s.exists()) { setCastle(s.data()); setNeedsOnboarding(false); } 
                    else { setNeedsOnboarding(true); }
                }));

                const subCol = (n, s) => { const q = s ? query(collection(db, basePath, n), orderBy(s.f, s.o)) : collection(db, basePath, n); subs.push(onSnapshot(q, (r) => { const data = r.docs.map(d => ({ id: d.id, ...d.data() })); if(n==='chores') { setChores(data); setDataLoaded(prev => ({...prev, chores: true})); } else if (n==='goals') { setGoals(data); setDataLoaded(prev => ({...prev, goals: true})); } else if(n==='coupons') setCoupons(data); else if(n==='bills') setBills(data); else if(n==='ious') setIous(data); else if(n==='events') setEvents(data); else if(n==='shopping') setShop(data); else if(n==='activities') setActivities(data); else if(n==='announcements') setAnnouncements(data); else if(n==='datenights') setDates(data); else if(n==='jokes') setJokes(data); else if(n==='notes') setNotes(data); })); };
                subCol('chores', {f:'createdAt',o:'asc'}); subCol('coupons'); subCol('bills'); subCol('ious', {f:'createdAt',o:'desc'}); subCol('goals'); subCol('events'); subCol('shopping'); subCol('activities', {f:'createdAt',o:'desc'}); subCol('announcements', {f:'createdAt',o:'desc'}); subCol('datenights', {f:'createdAt',o:'desc'}); subCol('jokes', {f:'createdAt',o:'desc'}); subCol('notes', {f:'createdAt',o:'desc'});
                
                const subDoc = (n, i, cb) => { subs.push(onSnapshot(doc(db, basePath, n, i), cb)); };
                subDoc('settings', 'income', (s) => setIncome(s.exists() ? s.data() : {ducky:0,pips:0}));
                subDoc('settings', 'profiles', (s) => { if(s.exists()) setProfiles(s.data()); });
                subDoc('settings', 'rewards', (s) => { if (s.exists()) setSettings(prev => ({ ...prev, rewards: s.data() })); });

                // --- STRIPE SUBSCRIPTION LISTENER (Robust & Parallel) ---
                const checkSubscription = () => {
                    // Helper to merge statuses (Priority: Active > Inactive)
                    let sources = { customers: 'waiting', users: 'waiting', claims: 'waiting' };
                    
                    const updateStatus = (source, status, details) => {
                        sources[source] = status;
                        
                        // If any source is active, we are good
                        if (sources.customers === 'active' || sources.users === 'active' || sources.claims === 'active') {
                            setSubscription(prev => ({ ...prev, status: 'active', debug: 'Active' }));
                        } else if (sources.customers !== 'waiting' && sources.users !== 'waiting') {
                            // Only set inactive if we've heard back from databases and none are active
                            setSubscription(prev => ({ ...prev, status: 'inactive' }));
                        }
                    };

                    // 1. Auth Claims (Fastest)
                    user.getIdTokenResult(true).then(token => {
                        const role = token.claims.stripeRole;
                        // Check if ANY stripe role exists or is 'premium'/'pro'
                        // Some setups use custom claims, others rely on DB.
                        // We check for truthiness of stripeRole as a baseline for 'active'.
                        updateStatus('claims', role ? 'active' : 'inactive', role ? 'Role Found' : 'No Role');
                    });

                    // 2. Customers Collection
                    const custSubRef = collection(db, 'customers', user.uid, 'subscriptions');
                    subs.push(onSnapshot(custSubRef, (snap) => {
                        if (snap.empty) {
                            updateStatus('customers', 'inactive', 'No docs');
                        } else {
                            const activeDoc = snap.docs.find(d => ['active', 'trialing'].includes(d.data().status));
                            updateStatus('customers', activeDoc ? 'active' : 'inactive', activeDoc ? 'Found Active' : `Status: ${snap.docs[0].data().status}`);
                        }
                    }, (err) => updateStatus('customers', 'error', err.message)));

                    // 3. Users Collection (Fallback)
                    const userSubRef = collection(db, 'users', user.uid, 'subscriptions');
                    subs.push(onSnapshot(userSubRef, (snap) => {
                         if (snap.empty) {
                            updateStatus('users', 'inactive', 'No docs');
                        } else {
                            const activeDoc = snap.docs.find(d => ['active', 'trialing'].includes(d.data().status));
                            updateStatus('users', activeDoc ? 'active' : 'inactive', activeDoc ? 'Found Active' : 'Docs inactive');
                        }
                    }, (err) => updateStatus('users', 'error', 'perm denied'))); 

                     // Debug: Check if checkout sessions exist (implies write permission is okay)
                    const sessionRef = collection(db, 'customers', user.uid, 'checkout_sessions');
                    subs.push(onSnapshot(sessionRef, (snap) => {
                        if (!snap.empty) {
                           setSubscription(prev => ({ ...prev, checkoutCreated: true }));
                        }
                    }));
                };

                checkSubscription();

                return () => subs.forEach(u => u && u());
            }, [user]);

            const act = async (type, col, id, data = {}) => {
                try {
                    const path = ['kingdoms', user.uid, col];
                    if (type === 'add') {
                        await addDoc(collection(db, ...path), { ...data, createdAt: serverTimestamp() });
                    } else if (type === 'update' && id) {
                        await updateDoc(doc(db, ...path, id), data);
                    } else if (type === 'delete' && id) {
                        if (!confirm("Are you sure you want to delete this?")) return;
                        await deleteDoc(doc(db, ...path, id));
                    } else if (type === 'set' && id) {
                        await setDoc(doc(db, ...path, id), data);
                    }
                } catch (e) {
                    console.error("Firebase Action Error:", e);
                }
            };

            // --- STRIPE SUBSCRIPTION ACTIONS ---

            // Updated handleManageSubscription
            const handleManageSubscription = async () => {
                if(!user) return;
                setPortalLoading(true);
                
                // Clean return URL (remove query params if any)
                const returnUrl = window.location.protocol === 'file:' 
                    ? "https://example.com/success" 
                    : window.location.origin + window.location.pathname;

                try {
                    const portalRef = await addDoc(collection(db, 'customers', user.uid, 'portal_sessions'), {
                        returnUrl: returnUrl,
                        return_url: returnUrl // send both to be safe
                    });

                    // Listen for response
                    const unsub = onSnapshot(portalRef, (snap) => {
                        const data = snap.data();
                        if(!data) return;

                        if (data.url) {
                            window.location.assign(data.url);
                        }
                        if (data.error) {
                            alert(`Error: ${data.error.message}`);
                            setPortalLoading(false);
                            unsub();
                        }
                    });
                } catch(e) {
                    console.error(e);
                    alert("Failed to create portal session. Please try again later.");
                    setPortalLoading(false);
                }
            };

            // Update handleSubscribe to remove logging
            const handleSubscribe = async () => {
                if(!user) return;
                
                if (user.isAnonymous) {
                    alert("Please Sign Out and create a real account to subscribe.");
                    return;
                }

                let returnUrl = window.location.protocol === 'file:' 
                    ? "https://example.com/success"
                    : window.location.origin + window.location.pathname;

                try {
                    const customerRef = doc(db, 'customers', user.uid);
                    await setDoc(customerRef, { email: user.email }, { merge: true });

                    const sessionRef = await addDoc(collection(db, 'customers', user.uid, 'checkout_sessions'), {
                        price: STRIPE_PRICE_ID,
                        success_url: returnUrl,
                        cancel_url: returnUrl,
                        allow_promotion_codes: true,
                        customer_email: user.email,
                        metadata: { firebase_uid: user.uid }
                    });

                    onSnapshot(sessionRef, (snap) => {
                        const data = snap.data();
                        if (!data) return;
                        if (data.error) {
                            alert(`Stripe Error: ${data.error.message}`);
                        }
                        if (data.url) {
                            window.location.assign(data.url);
                        }
                    });
                } catch(e) { 
                    console.error(e); 
                    alert(`Subscription Setup Failed: ${e.message}`);
                }
            };

            const handleInitialization = async (data) => {
                if (!user) return;
                const basePath = `kingdoms/${user.uid}`;
                await setDoc(doc(db, basePath, 'settings', 'castle'), { name: data.kingdomName, kingdomFlag: data.kingdomFlag, duckyFlag: data.p1.icon, pipsFlag: data.p2.icon });
                await setDoc(doc(db, basePath, 'settings', 'profiles'), { Ducky: data.p1, Pips: data.p2 });
                await setDoc(doc(db, basePath, 'settings', 'income'), { ducky: 0, pips: 0 });
                for(const t of data.initialChores) await addDoc(collection(db, basePath, 'chores'), { title: t, frequency: 'Weekly', assignedTo: null, status: 'pending', createdAt: serverTimestamp() });
                setNeedsOnboarding(false);
            };

            const myChores = useMemo(() => chores.filter(c => c.assignedTo === profile && c.status !== 'completed'), [chores, profile]);
            const unassigned = useMemo(() => chores.filter(c => !c.assignedTo && !(c.votes && profile && c.votes[profile])), [chores, profile]);
            const completed = useMemo(() => chores.filter(c => c.status === 'completed'), [chores]);
            const isHouseholdDeed = (c) => { if (c.type === 'whim') return false; if (c.goalId) { const g = goals.find(goal => goal.id === c.goalId); if (g && g.type === 'personal') return false; } return true; };
            const myCount = completed.filter(c => c.completedBy === profile && !c.redeemedForCoupon && isHouseholdDeed(c)).length;
            const totalCount = completed.filter(c => !c.redeemedForDate && isHouseholdDeed(c)).length;
            const myTheme = profile && profiles[profile] ? THEME_COLORS.find(c => c.name === profiles[profile].theme) || THEME_COLORS[0] : THEME_COLORS[0];
            const activeDate = useMemo(() => dates.find(d => d.status !== 'completed'), [dates]);
            const isPro = subscription.status === 'active';

            useEffect(() => { if (!profile || !chores.length) return; const threshold = settings.rewards?.choresPerCoupon || DEFAULT_CHORES_PER_COUPON; const un = completed.filter(c => c.completedBy === profile && !c.redeemedForCoupon && isHouseholdDeed(c)); if (un.length >= threshold) { const ids = un.slice(0, threshold).map(c => c.id); const pool = settings.rewards?.pools?.[profile] || DEFAULT_COUPONS; const randomCoupon = pool[Math.floor(Math.random() * pool.length)]; act('add', 'coupons', null, { title: randomCoupon, owner: profile, isUsed: false }); ids.forEach(id => act('update', 'chores', id, { redeemedForCoupon: true })); } }, [completed, profile, settings.rewards, goals]);
            
            // Habit generation with duplication check using Due Date + Data Loaded check
            useEffect(() => { 
                if (!profile || !goals.length || !dataLoaded.chores || !dataLoaded.goals) return; 
                const myActiveGoals = goals.filter(g => g.owner === profile || g.type === 'shared'); 
                const todayStr = new Date().toISOString().split('T')[0];

                myActiveGoals.forEach(goal => { 
                    if (goal.habits && goal.habits.length > 0) { 
                        goal.habits.forEach(habit => { 
                            const habitTitle = `${habit.text}`; 
                            const uniqueKey = `${goal.id}_${habit.id}_${todayStr}`;

                            if (processedHabitsRef.current.has(uniqueKey)) return;

                            const existsToday = chores.some(c => c.title === habitTitle && c.goalId === goal.id && c.dueDate && c.dueDate.split('T')[0] === todayStr); 
                            
                            if (existsToday) {
                                processedHabitsRef.current.add(uniqueKey);
                            } else if (habit.frequency === 'Daily') { 
                                processedHabitsRef.current.add(uniqueKey);
                                act('add', 'chores', null, { title: habitTitle, assignedTo: profile, type: 'habit', goalId: goal.id, frequency: 'Daily', status: 'pending', dueDate: new Date().toISOString(), createdAt: serverTimestamp() }); 
                            } 
                        }); 
                    } 
                }); 
            }, [goals, profile, chores, dataLoaded]);

            const openAddModal = () => { if (tab === 'budget') toggleModal('bill', true); else if (tab === 'goals') toggleModal('goal', true); else if (tab === 'calendar') toggleModal('event', true); else if (tab === 'shop') toggleModal('shop', true); else if (tab === 'jokes') toggleModal('joke', true); else if (tab === 'notes') toggleModal('note', true); else toggleModal('chore', true); };

            if (!user) return <AuthComponent />;
            if (needsOnboarding) return <Onboarding onComplete={handleInitialization} />;
            if (!profile) return (<div className="min-h-screen bg-pink-50 flex flex-col items-center justify-center p-6 text-center font-sans fade-in"><h1 className="text-5xl font-black text-pink-500 mb-10 drop-shadow-sm tracking-tight animate-bounce-slight">Who are you?</h1><div className="flex gap-8"><button onClick={() => {setProfile('Ducky'); localStorage.setItem('ducky_pips_profile', 'Ducky');}} className="w-44 h-44 bg-themeYellow rounded-[3rem] shadow-cute border-4 border-white flex flex-col items-center justify-center hover:scale-105 transition-transform"><div className="text-7xl mb-2">{profiles.Ducky?.icon || 'üê•'}</div><span className="text-2xl font-black text-themeYellowDark">{profiles.Ducky?.name || 'Ducky'}</span></button><button onClick={() => {setProfile('Pips'); localStorage.setItem('ducky_pips_profile', 'Pips');}} className="w-44 h-44 bg-themeBlue rounded-[3rem] shadow-cute border-4 border-white flex flex-col items-center justify-center hover:scale-105 transition-transform"><div className="text-7xl mb-2">{profiles.Pips?.icon || 'üê¶'}</div><span className="text-2xl font-black text-themeBlueDark">{profiles.Pips?.name || 'Pips'}</span></button></div><button onClick={() => signOut(auth)} className="mt-12 text-gray-400 font-bold text-sm hover:text-red-400 flex items-center gap-2"><LogOut size={16} /> Sign Out</button></div>);

            const historyItems = [...completed.map(c => ({ type: 'chore', who: c.completedBy, date: new Date(c.completedAt?.seconds * 1000 || Date.now()).toISOString(), desc: c.title })), ...dates.map(d => ({ type: 'date', who: 'Both', date: d.date || d.createdAt, desc: d.activity })), ...activities.map(a => ({ type: 'shopping', who: a.who, date: new Date(a.createdAt?.seconds * 1000 || Date.now()).toISOString(), desc: a.description, details: a.items ? a.items.join(', ') : '' }))].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            return (
                <ErrorBoundary>
                    <div className={`h-[100dvh] w-full flex flex-col font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative fade-in ${myTheme.bg} transition-colors duration-500`}>
                        <header className="bg-white/80 backdrop-blur-md p-5 pt-safe-top pb-4 shadow-sm z-10 flex justify-between items-center select-none rounded-b-[2.5rem] sticky top-0"><div className="flex items-center gap-3"><button onClick={() => toggleModal('profile', true)} className="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl shadow-sm border-2 border-gray-100 active:scale-95 transition-transform relative">{profiles[profile]?.icon}<div className="absolute -bottom-1 -right-1 bg-white rounded-full p-0.5 shadow-sm border border-gray-100"><Settings size={10} className="text-gray-400"/></div></button><div><h1 className="text-2xl font-black text-gray-800 tracking-tight flex items-center gap-2">{tab === 'castle' ? "Our Kingdom" : (tab.charAt(0).toUpperCase() + tab.slice(1))}</h1></div></div>
                        <div className="flex gap-2">
                            <button onClick={()=>toggleModal('subscription', true)} className={`p-2 rounded-full transition-colors border shadow-sm ${isPro ? 'bg-yellow-100 text-yellow-600 border-yellow-200' : 'bg-gray-50 text-gray-400 border-gray-100 hover:text-yellow-500'}`}><Star size={20} fill={isPro ? "currentColor" : "none"} /></button>
                            <button onClick={()=>toggleModal('help', true)} className="p-2 bg-blue-50 rounded-full text-blue-600 hover:text-blue-700 transition-colors border border-blue-100 shadow-sm"><CircleHelp size={20}/></button><button onClick={()=>toggleModal('announcement', true)} className="p-2 bg-gray-50 rounded-full text-purple-300 hover:text-purple-500 transition-colors"><Megaphone size={20}/></button><button onClick={() => {setProfile(null); localStorage.removeItem('ducky_pips_profile');}} className="p-2 bg-gray-50 rounded-full text-gray-300 hover:text-red-400 transition-colors"><LogOut size={20} /></button>{(!['rewards', 'dates', 'castle', 'shop', 'calendar', 'jokes', 'notes'].includes(tab) || (isPro && !['rewards', 'dates', 'castle'].includes(tab))) && <button onClick={openAddModal} className="w-12 h-12 bg-black text-white rounded-2xl flex items-center justify-center shadow-cute hover:scale-110 transition-transform active:scale-90"><Plus size={28} strokeWidth={3}/></button>}</div></header>
                        <main className="flex-1 overflow-y-auto p-4 pb-64 relative no-scrollbar overscroll-contain">
                            {tab === 'castle' && <CastleView chores={myChores} completed={completed} events={events} goals={goals} bills={bills} ious={ious} activities={activities} jokes={jokes} notes={notes} user={profile} settings={castle} profiles={profiles} announcements={announcements} onOpenSettings={() => toggleModal('castle', true)} onToggleChore={(c) => act('update', 'chores', c.id, {status: 'completed', completedAt: serverTimestamp(), completedBy: profile})} onOpenMeeting={() => toggleModal('meeting', true)} onOpenHistory={() => toggleModal('history', true)} />}
                            {tab === 'list' && <MyListView chores={myChores} onToggle={(c) => act('update', 'chores', c.id, {status: 'completed', completedAt: serverTimestamp(), completedBy: profile})} onDelete={(id) => act('delete', 'chores', id)} user={profile} progress={myCount} threshold={settings.rewards?.choresPerCoupon || DEFAULT_CHORES_PER_COUPON} onOpenRecurring={() => toggleModal('recurring', true)} />}
                            {tab === 'assign' && <AssignView chores={unassigned} profile={profile} onVote={(id, dir) => { const a=dir==='left'?'Pips':'Ducky'; const c=chores.find(x=>x.id===id); const o=profile==='Ducky'?'Pips':'Ducky'; if(c.votes&&c.votes[o]){ if(c.votes[o]===a) act('update','chores',id,{assignedTo:a,votes:{}}); else { setConflict({title:c.title}); act('update','chores',id,{votes:{},createdAt:serverTimestamp()}); } } else act('update','chores',id,{[`votes.${profile}`]:a}); }} />}
                            {tab === 'dates' && <DateNightView activeDate={activeDate} history={dates.filter(d => d.status === 'completed')} progress={totalCount} onLog={(d) => act('add', 'datenights', null, d)} onUpdateDate={(id, d) => act('update', 'datenights', id, d)} onCompleteDate={(id, d) => act('update', 'datenights', id, d)} resetProgress={(c) => completed.filter(x=>!x.redeemedForDate).sort((a,b)=>(a.completedAt?.seconds||0)-(b.createdAt?.seconds||0)).slice(0,c).forEach(x => act('update', 'chores', x.id, { redeemedForDate: true }))} threshold={settings.rewards?.choresPerDateNight || DEFAULT_CHORES_PER_DATENIGHT} user={profile} completed={completed} bills={bills} goals={goals} activities={activities} events={events} jokes={jokes} notes={notes} ious={ious} profiles={profiles} settings={settings} />}
                            {tab === 'budget' && <BudgetView bills={bills} income={income} ious={ious} user={profile} onUpdateIncome={(d) => act('set', 'settings', 'income', {...income, ...d})} onPayBill={(b) => { setSelectedBill(b); toggleModal('payment', true); }} onEditBill={(b) => setEditingBill(b)} onRequestIOU={() => toggleModal('iou', true)} onPayIOU={(iou) => { setSelectedIOU(iou); toggleModal('iouPayment', true); }} onClearIOU={(id) => act('delete', 'ious', id)} onApproveIOU={(id) => act('update', 'ious', id, {status: 'approved'})} onDeleteIOU={(id) => act('delete', 'ious', id)} />}
                            {tab === 'shop' && (!isPro ? <Paywall title="Shared Shopping List" description="Sync your grocery runs and wishlist items in real-time." icon={<ShoppingCart size={48} className="text-orange-400"/>} onSubscribe={() => toggleModal('subscription', true)} /> : <ShoppingListView items={shop} onAdd={(d) => act('add', 'shopping', null, d)} onToggle={(id, c) => act('update', 'shopping', id, { completed: c })} onDelete={(id) => act('delete', 'shopping', id)} onFinishShopping={(total) => { const completedItems = shop.filter(i => i.completed); act('add', 'activities', null, { who: profile, description: `Shopping ($${total})`, items: completedItems.map(i => i.text) }); completedItems.forEach(i => act('delete', 'shopping', i.id)); setShoppingMode(false); toggleModal('shoppingComplete', false); }} isShoppingMode={isShoppingMode} setShoppingMode={setShoppingMode} user={profile} />)}
                            {tab === 'goals' && <GoalsView goals={goals} user={profile} onUpdate={(id, d) => act('update', 'goals', id, d)} onDelete={(id) => act('delete', 'goals', id)} />}
                            {tab === 'rewards' && <RewardsView coupons={coupons} currentUser={profile} onRedeem={(c) => setRedeem(c)} />}
                            {tab === 'calendar' && (!isPro ? <Paywall title="Unlock Planning" description="Coordinate your royal schedule with shared events and reminders." icon={<CalendarDays size={48} className="text-pink-400"/>} onSubscribe={() => toggleModal('subscription', true)} /> : <CalendarView events={events} user={profile} onAck={(id) => { const e = events.find((x)=>x.id===id); if(e) act('update', 'events', id, { acks: {...e.acks, [profile]: true} }); }} onDelete={(id) => act('delete', 'events', id)} />)}
                            {tab === 'jokes' && (!isPro ? <Paywall title="Unlock Jokes" description="Track the funniest moments in your kingdom and crown the Court Jester." icon={<Smile size={48} className="text-yellow-400"/>} onSubscribe={() => toggleModal('subscription', true)} /> : <JokesView jokes={jokes} onAdd={(d) => act('add', 'jokes', null, d)} onDelete={(id) => act('delete', 'jokes', id)} user={profile} />)}
                            {tab === 'notes' && (!isPro ? <Paywall title="Unlock Notes" description="Pin important household info, wifi passwords, and love notes." icon={<StickyNote size={48} className="text-blue-400"/>} onSubscribe={() => toggleModal('subscription', true)} /> : <NotesView notes={notes} onAdd={(d) => act('add', 'notes', null, {...d, createdBy: profile, blocks: [{id: '1', text: d.content, author: profile}]})} onDelete={(id) => act('delete', 'notes', id)} onEdit={(note) => setEditingNote(note)} user={profile} />)}
                        </main>
                        <div className="fixed bottom-0 left-0 right-0 w-full px-4 pb-6 pt-12 z-40 flex justify-between items-end pointer-events-none safe-area-pb">
                            <div className="bg-white/95 backdrop-blur-md rounded-[2.5rem] p-1.5 grid grid-cols-2 gap-1 shadow-xl border-4 border-white pointer-events-auto w-[42%]">
                                <NavButton active={tab === 'jokes'} onClick={() => setTab('jokes')} icon={<Smile />} label="Jokes" />
                                <NavButton active={tab === 'dates'} onClick={() => setTab('dates')} icon={<Heart />} label="Dates" />
                                <NavButton active={tab === 'calendar'} onClick={() => setTab('calendar')} icon={<CalendarDays />} label="Plan" />
                                <NavButton active={tab === 'list'} onClick={() => setTab('list')} icon={<CheckCircle />} label="Chores" />
                                <NavButton active={tab === 'assign'} onClick={() => setTab('assign')} icon={<Repeat />} label="Assign" />
                                <div className="flex items-center justify-center opacity-30 grayscale"><span className="text-2xl">{castle.kingdomFlag}</span></div>
                            </div>
                            <div className="pointer-events-auto -mb-6 mx-1 z-50 transform -translate-y-6 flex-1 flex justify-center"><NavButton active={tab === 'castle'} onClick={() => setTab('castle')} icon={<Crown />} label="Kingdom" prominent={true} /></div>
                            <div className="bg-white/95 backdrop-blur-md rounded-[2.5rem] p-1.5 grid grid-cols-2 gap-1 shadow-xl border-4 border-white pointer-events-auto w-[42%]">
                                <NavButton active={tab === 'budget'} onClick={() => setTab('budget')} icon={<PiggyBank />} label="Budget" />
                                <NavButton active={tab === 'notes'} onClick={() => setTab('notes')} icon={<StickyNote />} label="Notes" />
                                <NavButton active={tab === 'shop'} onClick={() => setTab('shop')} icon={<ShoppingCart />} label="Shop" />
                                <NavButton active={tab === 'goals'} onClick={() => setTab('goals')} icon={<Target />} label="Goals" />
                                <div className="flex items-center justify-center opacity-30 grayscale"><span className="text-2xl">{castle.kingdomFlag}</span></div>
                                <NavButton active={tab === 'rewards'} onClick={() => setTab('rewards')} icon={<Gift />} label="Rewards" />
                            </div>
                        </div>

                        {modals.chore && <AddChoreModal onClose={() => toggleModal('chore', false)} onAdd={(d) => { let assigned = null; if (d.isPrettyPlease) assigned = profile === 'Ducky' ? 'Pips' : 'Ducky'; if (d.type === 'whim') assigned = profile; act('add', 'chores', null, { ...d, status: 'pending', assignedTo: assigned, createdBy: profile, votes: {} }); toggleModal('chore', false); }} profile={profile} />}
                        {modals.bill && <AddBillModal onClose={() => toggleModal('bill', false)} onAdd={(d) => { act('add', 'bills', null, { ...d, totalPaid: 0, payments: [] }); toggleModal('bill', false); }} />}
                        {modals.goal && <AddGoalModal onClose={() => toggleModal('goal', false)} onAdd={(d) => { act('add', 'goals', null, { ...d, savedAmount: 0, tasks: [], contributions: [] }); toggleModal('goal', false); }} user={profile} />}
                        {modals.event && <AddEventModal onClose={() => toggleModal('event', false)} onAdd={(d) => { const pl = { ...d, acks: {[profile]: true} }; if(d.type==='shared') pl.acks[profile==='Ducky'?'Pips':'Ducky'] = false; act('add', 'events', null, pl); toggleModal('event', false); }} user={profile} />}
                        {modals.iou && <IOUModal onClose={() => toggleModal('iou', false)} onRequest={(amt, res) => { act('add', 'ious', null, { from: profile, to: profile==='Ducky'?'Pips':'Ducky', amount: parseFloat(amt), reason: res, status: 'pending' }); toggleModal('iou', false); }} />}
                        {modals.meeting && <MeetingModal onClose={() => toggleModal('meeting', false)} chores={chores} events={events} user={profile} onAdd={(d) => act('add', 'chores', null, { ...d, status: 'pending', createdBy: profile, votes: {} })} />}
                        {modals.shop && <AddShoppingModal onClose={() => toggleModal('shop', false)} onAdd={(d) => { act('add', 'shopping', null, d); toggleModal('shop', false); }} user={profile} />}
                        {modals.profile && <ProfileSettingsModal onClose={() => toggleModal('profile', false)} profile={profile} settings={profiles[profile]} onSave={(s) => act('set', 'settings', 'profiles', { ...profiles, [profile]: s })} />}
                        {modals.history && <CastleHistoryModal onClose={() => toggleModal('history', false)} history={historyItems} />}
                        {modals.rewardSettings && <RewardSettingsModal onClose={() => toggleModal('rewardSettings', false)} settings={settings} onUpdateSettings={(newSettings) => { act('set', 'settings', 'rewards', newSettings.rewards); setSettings(newSettings); }} />}
                        {modals.payment && selectedBill && <PaymentModal onClose={() => toggleModal('payment', false)} bill={selectedBill} onPay={(amt) => { const newTotal = (selectedBill.totalPaid || 0) + amt; const newPayments = [...(selectedBill.payments || []), { who: profile, amount: amt, date: new Date().toISOString() }]; act('update', 'bills', selectedBill.id, { totalPaid: newTotal, payments: newPayments }); toggleModal('payment', false); }} />}
                        {modals.shoppingComplete && <ShoppingCompleteModal onClose={() => toggleModal('shoppingComplete', false)} onComplete={(total) => { const completedItems = shop.filter(i => i.completed); act('add', 'activities', null, { who: profile, description: `Shopping ($${total})`, items: completedItems.map(i => i.text) }); completedItems.forEach(i => act('delete', 'shopping', i.id)); setShoppingMode(false); toggleModal('shoppingComplete', false); }} />}
                        {modals.announcement && <AnnouncementModal onClose={() => toggleModal('announcement', false)} onSend={(msg) => { announcements.forEach(a => { if(a.active) act('update', 'announcements', a.id, { active: false }); }); act('add', 'announcements', null, { message: msg, from: profile, active: true }); toggleModal('announcement', false); }} />}
                        {modals.help && <HelpModal onClose={() => toggleModal('help', false)} tab={tab} />}
                        {modals.recurring && <RecurringManagerModal onClose={() => toggleModal('recurring', false)} goals={goals} onDeleteHabit={(goalId, habitId) => { const goal = goals.find(g => g.id === goalId); if (goal && goal.habits) { const newHabits = goal.habits.filter((h) => h.id !== habitId); act('update', 'goals', goalId, { habits: newHabits }); } }} />}
                        {modals.iouPayment && selectedIOU && <IOUPaymentModal onClose={() => { toggleModal('iouPayment', false); setSelectedIOU(null); }} iou={selectedIOU} onPay={(amt) => { const newAmt = selectedIOU.amount - amt; if (newAmt <= 0) act('delete', 'ious', selectedIOU.id); else act('update', 'ious', selectedIOU.id, { amount: newAmt }); toggleModal('iouPayment', false); setSelectedIOU(null); }} />}
                        {modals.castle && <CastleSettingsModal onClose={() => toggleModal('castle', false)} settings={castle} onUpdateSettings={(s) => act('set', 'settings', 'castle', s)} onOpenProfile={() => toggleModal('profile', true)} />}
                        {modals.joke && <AddJokeModal onClose={() => toggleModal('joke', false)} onAdd={(d) => { act('add', 'jokes', null, d); toggleModal('joke', false); }} />}
                        {modals.note && <AddNoteModal onClose={() => toggleModal('note', false)} onAdd={(d) => { act('add', 'notes', null, { ...d, createdBy: profile }); toggleModal('note', false); }} />}
                        
                        {/* Note Editor Modal */}
                        {editingNote && <NoteEditorModal note={editingNote} currentUser={profile} onClose={() => setEditingNote(null)} onDelete={(id) => { act('delete', 'notes', id); setEditingNote(null); }} onSave={(updatedNote) => { act('update', 'notes', updatedNote.id, updatedNote); setEditingNote(null); }} />}
                        
                        {/* Edit Bill Modal */}
                        {editingBill && <EditBillModal bill={editingBill} onClose={() => setEditingBill(null)} onUpdate={(id, d) => act('update', 'bills', id, d)} onDelete={(id) => act('delete', 'bills', id)} />}

                        {/* Conflict Modal */}
                        {conflict && <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 animate-in fade-in"><div className="bg-white rounded-[2rem] p-6 max-w-sm w-full text-center relative overflow-hidden shadow-2xl border-4 border-white"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><MessageCircle size={32} className="text-red-500" /></div><h3 className="text-xl font-black text-gray-800 mb-2">Wait, discuss this!</h3><p className="text-gray-500 mb-4 text-sm font-medium">Differing votes for <span className="font-bold text-gray-800">"{conflict.title}"</span>.</p><button onClick={() => setConflict(null)} className="w-full bg-black text-white py-3 rounded-xl font-bold shadow-cute">Okay</button></div></div>}
                        
                        {/* Redeem Modal */}
                        {redeem && <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 animate-in fade-in"><div className="bg-white rounded-[2rem] p-6 max-w-sm w-full text-center relative overflow-hidden shadow-2xl border-4 border-white"><div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4"><Gift size={32} className="text-indigo-600" /></div><h3 className="text-xl font-black text-gray-800 mb-2">Redeem?</h3><p className="text-gray-500 mb-6 text-sm font-medium">Use <span className="font-bold text-gray-800">"{redeem.title}"</span>?</p><div className="flex gap-3"><button onClick={() => setRedeem(null)} className="flex-1 py-3 font-bold text-gray-500 hover:bg-gray-100 rounded-xl">Cancel</button><button onClick={() => { act('update', 'coupons', redeem.id, { isUsed: true }); setRedeem(null); }} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-cute">Use It!</button></div></div></div>}
                        
                        {/* Subscription Modal */}
                        {modals.subscription && (
                            <ModalWrapper onClose={() => toggleModal('subscription', false)} title="Kingdom Pro" icon={<Star className="text-yellow-400" size={28}/>}>
                                <div className="space-y-6 text-center">
                                    <div className="bg-gradient-to-br from-yellow-100 to-orange-100 p-6 rounded-3xl border-2 border-yellow-200">
                                        <h3 className="text-xl font-black text-yellow-800 mb-2">Unlock the Full Kingdom</h3>
                                        <p className="text-sm text-yellow-700 font-medium leading-relaxed">Upgrade your castle to access premium tools for organizing your royal life.</p>
                                    </div>
                                    <div className="space-y-3 text-left">
                                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"><div className="bg-blue-100 p-2 rounded-lg text-blue-500"><CalendarDays size={20}/></div><span className="font-bold text-gray-700 text-sm">Advanced Planning Calendar</span></div>
                                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"><div className="bg-orange-100 p-2 rounded-lg text-orange-500"><ShoppingCart size={20}/></div><span className="font-bold text-gray-700 text-sm">Shared Shopping List</span></div>
                                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"><div className="bg-yellow-100 p-2 rounded-lg text-yellow-500"><Smile size={20}/></div><span className="font-bold text-gray-700 text-sm">Joke Tracker & Leaderboard</span></div>
                                        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl"><div className="bg-purple-100 p-2 rounded-lg text-purple-500"><StickyNote size={20}/></div><span className="font-bold text-gray-700 text-sm">Royal Scribe Notes</span></div>
                                    </div>
                                    
                                    {!isPro ? (
                                        <div className="space-y-2">
                                            <button 
                                                onClick={handleSubscribe} 
                                                className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-lg hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2"
                                            >
                                                Subscribe for $14.99/mo <ArrowRight size={18}/>
                                            </button>
                                            
                                            <div className="text-[10px] text-gray-400 mt-2 text-center">
                                                Secure payment via Stripe. <br/>
                                                <button onClick={() => window.location.reload()} className="underline font-bold text-gray-500 hover:text-black mt-1">Already paid? Refresh.</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <div className="bg-green-100 text-green-700 py-3 rounded-xl font-bold border border-green-200">
                                                You are a Pro Member! üåü
                                            </div>
                                            <button 
                                                onClick={() => window.location.reload()} 
                                                className="w-full py-3 bg-gray-100 text-gray-600 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-gray-200"
                                            >
                                                <RefreshCcw size={14}/> Force Refresh Status
                                            </button>
                                            <button 
                                                onClick={handleManageSubscription} 
                                                disabled={portalLoading}
                                                className="w-full py-3 bg-white border-2 border-gray-100 text-gray-600 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-gray-50 disabled:opacity-50"
                                            >
                                                {portalLoading ? <Loader className="animate-spin" size={14} /> : <ExternalLink size={14}/>}
                                                {portalLoading ? "Opening..." : "Manage / Cancel Subscription"}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </ModalWrapper>
                        )}
                    </div>
                </ErrorBoundary>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>